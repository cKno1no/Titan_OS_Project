{% extends "base.html" %}
{% block title %}Nh·∫≠t k√Ω H·ªá th·ªëng | Titan OS{% endblock %}

{% block extra_css %}
<style>
    .audit-header {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 1rem; padding: 1.5rem; color: white;
    }
    .table-audit { font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85rem; }
    .table-audit tbody tr { border-bottom: 1px solid #f1f5f9; }
    
    /* Highlight theo Tab */
    .tab-active { border-bottom: 3px solid #3b82f6 !important; color: #3b82f6 !important; font-weight: bold; }
    .nav-link { cursor: pointer; color: #64748b; transition: all 0.3s; }
    .nav-link:hover { color: #3b82f6; }

    /* M·ª©c ƒë·ªô Log */
    .row-INFO { color: #64748b; } 
    .row-WARNING { background-color: #fffbeb !important; color: #b45309; font-weight: 500; }
    .row-CRITICAL { background-color: #fef2f2 !important; color: #b91c1c; font-weight: bold; border-left: 4px solid #ef4444;}
    
    .badge-severity { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;}
    .badge-INFO { background: #e2e8f0; color: #475569; }
    .badge-WARNING { background: #fde68a; color: #d97706; }
    .badge-CRITICAL { background: #fca5a5; color: #991b1b; }

    .details-cell { max-width: 450px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    .sticky-top { top: 0; z-index: 1020; background: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" x-data="auditApp()" x-init="init()">
    
    <div class="audit-header mb-4 d-flex justify-content-between align-items-center shadow-sm">
        <div>
            <h4 class="fw-bold mb-1"><i class="fas fa-eye me-2 text-warning"></i>TRUNG T√ÇM GI√ÅM S√ÅT "M·∫ÆT TH·∫¶N"</h4>
            <p class="mb-0 text-white-50 small">Truy v·∫øt h√†nh vi ng∆∞·ªùi d√πng v√† nh·∫≠t k√Ω API h·ªá th·ªëng.</p>
        </div>
        <div class="d-flex gap-2 bg-white p-2 rounded-3 shadow-sm">
            <input type="date" x-model="dateFrom" class="form-control form-control-sm border-0 bg-light">
            <span class="text-dark align-self-center fw-bold">-</span>
            <input type="date" x-model="dateTo" class="form-control form-control-sm border-0 bg-light">
            <button class="btn btn-primary btn-sm fw-bold px-3" @click="fetchLogs()">
                <i class="fas fa-sync-alt me-1"></i> T·∫£i l·∫°i
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 mb-4">
        <div class="card-header bg-white border-0 p-0">
            <ul class="nav nav-justified border-bottom">
                <li class="nav-item">
                    <a class="nav-link py-3" :class="activeTab === 'BUSINESS' ? 'tab-active' : ''" @click="switchTab('BUSINESS')">
                        <i class="fas fa-user-shield me-2"></i> üöÄ LOG NGHI·ªÜP V·ª§ (H√†nh vi User)
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link py-3" :class="activeTab === 'SYSTEM' ? 'tab-active' : ''" @click="switchTab('SYSTEM')">
                        <i class="fas fa-robot me-2"></i> ‚öôÔ∏è LOG H·ªÜ TH·ªêNG (API & Middleware)
                    </a>
                </li>
            </ul>
        </div>

        <div class="card-body bg-light border-bottom py-2">
            <div class="row g-2">
                <div class="col-md-3">
                    <select x-model="severity" class="form-select form-select-sm" @change="fetchLogs()">
                        <option value="">üéØ T·∫•t c·∫£ m·ª©c ƒë·ªô</option>
                        <option value="CRITICAL">üî¥ Critical (X√≥a/Quy·ªÅn)</option>
                        <option value="WARNING">üü† Warning (L·ªói/C·∫£nh b√°o)</option>
                        <option value="INFO">‚ö™ Info (Th√¥ng th∆∞·ªùng)</option>
                    </select>
                </div>
                <div class="col-md-9">
                    <input type="text" x-model="search" class="form-control form-control-sm" 
                           placeholder="üîç T√¨m theo M√£ NV, Action ho·∫∑c n·ªôi dung chi ti·∫øt..." @keyup.enter="fetchLogs()">
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 65vh; overflow-y: auto;">
                <table class="table table-audit mb-0 align-middle table-hover">
                    <thead class="bg-white text-muted text-uppercase sticky-top" style="font-size: 0.75rem; border-bottom: 2px solid #e2e8f0;">
                        <tr>
                            <th class="ps-4">Th·ªùi gian</th>
                            <th>M·ª©c ƒë·ªô</th>
                            <th>Thao t√°c</th>
                            <th>Ng∆∞·ªùi d√πng</th>
                            <th style="max-width: 450px;">Chi ti·∫øt Payload</th>
                            <th>IP Client</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-if="isLoading">
                            <tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                        </template>
                        <template x-if="!isLoading && logs.length === 0">
                            <tr><td colspan="6" class="text-center py-5 text-muted">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p.</td></tr>
                        </template>
                        <template x-for="log in logs" :key="log.LogID">
                            <tr :class="'row-' + log.Severity">
                                <td class="ps-4 text-nowrap" x-text="log.CreatedAt"></td>
                                <td><span :class="'badge-severity badge-' + log.Severity" x-text="log.Severity"></span></td>
                                <td class="fw-bold">
                                    <i :class="getIcon(log)" class="me-2"></i>
                                    <span x-text="log.ActionType"></span>
                                </td>
                                <td>
                                    <span class="badge bg-white text-dark border">
                                        <i class="fas fa-user-circle me-1 text-secondary"></i>
                                        <span x-text="log.UserCode"></span>
                                    </span>
                                </td>
                                <td class="details-cell" @click="showFullData(log.Details)" x-html="formatDetails(log.Details)"></td>
                                <td class="text-muted small" x-text="log.IPAddress"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white border-0 py-2">
            <small class="text-muted">Hi·ªÉn th·ªã t·ªëi ƒëa 1000 b·∫£n ghi m·ªõi nh·∫•t trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</small>
        </div>
    </div>
</div>

<div class="modal fade" id="jsonModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-dark text-white rounded-top-4">
                <h6 class="modal-title font-monospace"><i class="fas fa-laptop-code me-2"></i> Truy v·∫øt Chi ti·∫øt (Log Details)</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-0">
                <pre class="m-0 p-4" style="max-height: 50vh; overflow-y: auto;"><code id="jsonContent" class="text-dark" style="font-size: 0.85rem; white-space: pre-wrap;"></code></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
    function auditApp() {
        return {
            isLoading: false,
            activeTab: 'BUSINESS',
            logs: [],
            severity: '',
            search: '',
            dateFrom: '',
            dateTo: '',

            init() {
                // M·∫∑c ƒë·ªãnh xem 7 ng√†y g·∫ßn nh·∫•t
                const today = new Date();
                const lastWeek = new Date();
                lastWeek.setDate(today.getDate() - 7);
                
                this.dateTo = today.toISOString().split('T')[0];
                this.dateFrom = lastWeek.toISOString().split('T')[0];
                
                this.fetchLogs();
            },

            async switchTab(tabName) {
                this.activeTab = tabName;
                await this.fetchLogs();
            },

            async fetchLogs() {
                this.isLoading = true;
                try {
                    const url = `/api/admin/logs/stream?tab=${this.activeTab}&severity=${this.severity}&user=${this.search}&date_from=${this.dateFrom}&date_to=${this.dateTo}&limit=1000`;
                    const res = await fetch(url);
                    this.logs = await res.json();
                } catch (e) {
                    console.error("L·ªói t·∫£i log:", e);
                } finally {
                    this.isLoading = false;
                }
            },

            getIcon(log) {
                if (log.ActionType.includes('LOGIN')) return 'fas fa-key text-success';
                if (log.ActionType.includes('COMPLETED')) return 'fas fa-check-double text-primary';
                if (log.ActionType.includes('START')) return 'fas fa-play-circle text-info';
                if (log.ActionType.includes('AUTO_')) return 'fas fa-robot text-muted';
                if (log.Severity === 'CRITICAL') return 'fas fa-fire';
                return 'fas fa-info-circle';
            },

            formatDetails(details) {
                if (!details) return '';
                if (details.includes('Data: {')) {
                    return details.split('Data: {')[0] + ' <span class="badge bg-info text-dark ms-1" style="font-size: 0.6rem;">{JSON}</span>';
                }
                return details;
            },

            showFullData(rawData) {
                let displayHtml = rawData;
                if(rawData.includes('Data: {')) {
                    let parts = rawData.split('Data: {');
                    let jsonPart = '{' + parts[1].split('...[TRUNCATED]')[0]; // X·ª≠ l√Ω n·∫øu b·ªã c·∫Øt
                    try {
                        let jsonObj = JSON.parse(jsonPart);
                        displayHtml = `„Äê SUMMARY „Äë\n${parts[0]}\n\n„Äê PAYLOAD DATA „Äë\n` + JSON.stringify(jsonObj, null, 4);
                    } catch(e) {
                        displayHtml = rawData; 
                    }
                }
                document.getElementById('jsonContent').textContent = displayHtml;
                new bootstrap.Modal(document.getElementById('jsonModal')).show();
            }
        }
    }
</script>
{% endblock %}