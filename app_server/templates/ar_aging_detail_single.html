{% extends "base.html" %}

{% block title %}Chi Tiết Công Nợ: {{ kpi.ObjectName }}{% endblock %}

{% block extra_css %}
<style>
    /* KPI CARDS */
    .kpi-card {
        background: var(--card-bg); border-radius: 16px; padding: 20px;
        box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        height: 100%; text-align: center; transition: transform 0.2s;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .kpi-card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .kpi-label { color: var(--secondary); font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; }
    .kpi-value { color: var(--text-dark); font-size: 1.8rem; font-weight: 700; line-height: 1; }
    
    .val-total { color: var(--text-dark); }
    .val-risk { color: var(--danger); }
    .val-warn { color: #E65100; }

    /* DETAIL TABLE */
    .table-detail th { 
        background-color: var(--input-bg) !important; color: var(--danger) !important;
        font-weight: 700; font-size: 0.85rem; text-transform: uppercase;
        text-align: center; padding: 15px; border-bottom: 2px solid var(--border-color);
    }
    .table-detail td { 
        vertical-align: middle; font-size: 0.95rem; padding: 12px 15px;
        border-bottom: 1px solid var(--border-color); color: var(--text-dark);
    }
    .table-detail tbody tr:hover td { background-color: var(--input-bg); }
    
    .debt-overdue { 
        color: white; background-color: var(--danger); 
        padding: 4px 8px; border-radius: 8px; font-weight: 700; font-size: 0.85rem;
    }
    
    /* Toggle Switch */
    .form-check-input { background-color: var(--input-bg); border-color: var(--border-color); }
    .form-check-input:checked { background-color: var(--danger); border-color: var(--danger); }
    .toggle-label { color: var(--text-dark); font-weight: 600; }
    
    /* DataTables Theme Override */
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_info { color: var(--secondary) !important; padding: 10px; }
    .dataTables_wrapper .dataTables_paginate .paginate_button { color: var(--secondary) !important; }
    .dataTables_wrapper .dataTables_filter input { background-color: var(--input-bg); color: var(--text-dark); border: 1px solid var(--border-color); }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-file-invoice-dollar me-2 text-primary"></i> CHI TIẾT CÔNG NỢ{% endblock %}
{% block page_sub %}
    <span class="text-primary fw-bold">{{ kpi.ObjectName | default('N/A') }}</span> 
    <span class="text-muted font-monospace">({{ kpi.ObjectID }})</span>
{% endblock %}

{% block header_actions %}
<a href="{{ url_for('kpi_bp.ar_aging_dashboard') }}" class="btn btn-back"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
{% endblock %}

{% block content %}
    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="kpi-card">
                <div class="kpi-label">TỔNG CÔNG NỢ</div>
                <div class="kpi-value val-total">{{ kpi.TotalDebt | format_tr }}</div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="kpi-card">
                <div class="kpi-label text-danger">TỔNG NỢ QUÁ HẠN</div>
                <div class="kpi-value val-risk">{{ kpi.TotalOverdueDebt | format_tr }}</div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="kpi-card">
                <div class="kpi-label" style="color: #E65100;">NỢ RỦI RO (> 180 NGÀY)</div>
                <div class="kpi-value val-warn">{{ kpi.Debt_Over_180 | format_tr }}</div>
            </div>
        </div>
    </div>

    <div class="main-card">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <span class="text-danger fw-bold"><i class="fas fa-list-ul me-2"></i> Danh sách Hóa đơn Còn nợ</span>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleOverdue">
                <label class="form-check-label toggle-label" for="toggleOverdue">Chỉ hiện Nợ Quá Hạn</label>
            </div>
        </div>
        
        <div class="card-body-custom p-0">
            <div class="table-responsive">
                <table id="ar-aging-detail-table" class="table table-hover mb-0 table-detail">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Số Hóa Đơn</th>
                            <th>Ngày Hóa Đơn</th>
                            <th>Số ngày Nợ (Tổng)</th> 
                            <th class="text-end">Giá trị Nợ (Còn lại)</th>
                        </tr>
                    </thead>
                    <tbody id="aging-detail-body">
                        {% for row in aging_details %}
                        <tr data-is-overdue="{{ 'true' if row.OverdueDays > 0 else 'false' }}">
                            <td class="text-center text-muted"></td>
                            <td class="text-center fw-bold text-primary">{{ row.InvoiceNo }}</td>
                            <td class="text-center">{{ row.VoucherDate | format_date }}</td>
                            <td class="text-center">
                                {% if row.OverdueDays > 0 %}
                                    <span class="debt-overdue">{{ row.TotalDebtDays | default(row.OverdueDays) }}</span>
                                {% else %}
                                    <span class="text-success fw-bold">{{ row.TotalDebtDays | default(row.OverdueDays) }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold" style="font-size: 1rem;">{{ row.RemainingBalance | format_number }}</td>
                        </tr>
                        {% else %}
                        <tr class="data-table-empty">
                            <td colspan="5" class="text-center text-muted py-4">Không tìm thấy chi tiết công nợ.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>
    <script>
        $(document).ready(function() {
            const hasDataRows = $('#aging-detail-body tr:not(.data-table-empty)').length > 0;
            
            if (hasDataRows) {
                const arAgingTable = $('#ar-aging-detail-table').DataTable({
                    "paging": true, "pageLength": 25, "lengthChange": true, "searching": true, 
                    "ordering": true, "info": true, "order": [[3, 'desc']], 
                    "language": { "search": "Lọc nhanh:", "paginate": { "next": ">", "previous": "<" } },
                    "columnDefs": [
                        { "width": "5%", "targets": 0, "orderable": false, "className": "text-center",
                          "render": function (data, type, row, meta) { return meta.row + meta.settings._iDisplayStart + 1; } }
                    ]
                });
            
                // Custom Filter for Overdue Only
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        if (settings.nTable.id !== 'ar-aging-detail-table') return true;
                        if (!$('#toggleOverdue').is(':checked')) return true;
                        const overdueDaysText = $(arAgingTable.cell(dataIndex, 3).node()).text();
                        return parseFloat(overdueDaysText) > 0;
                    }
                );

                $('#toggleOverdue').on('change', function() { arAgingTable.draw(); });
            }
        });
    </script>
{% endblock %}