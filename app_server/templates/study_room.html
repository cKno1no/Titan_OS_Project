{% extends "base.html" %}

{% block title %}H·ªçc: {{ material.FileName }}{% endblock %}

{% block content %}
<style>
    /* Ch·∫ø ƒë·ªô Focus: ·∫®n Header/Sidebar/Footer c·ªßa Base Layout ƒë·ªÉ t·∫≠p trung h·ªçc */
    .page-header, .sidebar, .main-footer, .navbar { display: none !important; }
    .container-fluid { padding: 0 !important; max-width: 100% !important; margin: 0 !important; }
    body { overflow: hidden; background: #2b2d31; } 
    
    /* T√πy ch·ªânh Scrollbar cho ƒë·∫πp */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* C√°c class ph·ª• tr·ª£ */
    .hover-bg-light:hover { background-color: #f8f9fa; }
    .cursor-pointer { cursor: pointer; }
    
    /* CSS cho v√≤ng tr√≤n ti·∫øn ƒë·ªô (Circular Progress) */
    .circular-chart { display: block; margin: 0 auto; max-width: 80%; max-height: 250px; }
    .circle-bg { fill: none; stroke: #eee; stroke-width: 3.8; }
    .circle { 
        fill: none; 
        stroke-width: 2.8; 
        stroke-linecap: round; 
        animation: progress 1s ease-out forwards; 
        stroke: #0d6efd; 
        transition: stroke-dasharray 0.3s; 
    }
</style>

<div class="d-flex h-100vh w-100">
    
    <div class="flex-grow-1 position-relative bg-dark d-flex flex-column" style="height: 100vh;">
        <div class="bg-secondary text-white p-2 d-flex justify-content-between align-items-center shadow-sm z-10">
            <a href="/training/course/{{ material.CourseID }}" class="btn btn-sm btn-dark border-0">
                <i class="fas fa-arrow-left me-1"></i> Tr·ªü v·ªÅ kh√≥a h·ªçc
            </a>
            <span class="fw-bold small text-truncate" style="max-width: 400px;">{{ material.FileName }}</span>
            <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-dark mx-1" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                <span class="mx-2 small user-select-none">Trang <span id="page_num">1</span> / <span id="page_count">--</span></span>
                <button class="btn btn-sm btn-dark mx-1" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="pdf-container" class="flex-grow-1 overflow-auto d-flex justify-content-center p-4" style="background: #525659;">
            <canvas id="the-canvas" class="shadow-lg"></canvas>
        </div>
    </div>

    <div class="bg-white border-start d-flex flex-column shadow-lg position-relative" style="width: 400px; height: 100vh; min-width: 350px;">
        
        <div class="p-3 border-bottom bg-light d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="avatar bg-gradient-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h6 class="m-0 fw-bold text-dark">Titan Tutor</h6>
                    <small class="text-success" style="font-size: 0.7rem;"><i class="fas fa-circle me-1"></i>Online</small>
                </div>
            </div>
            <div class="position-relative d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                 <svg viewBox="0 0 36 36" class="circular-chart text-primary w-100 h-100">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" id="prog-circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                </svg>
                <span class="position-absolute small fw-bold" id="read-percent">0%</span>
            </div>
        </div>

        <div id="chat-history" class="flex-grow-1 p-3 overflow-auto" style="background: #f8f9fa;">
            <div class="d-flex mb-3">
                <div class="bg-white p-3 rounded-3 shadow-sm border" style="max-width: 90%;">
                    <p class="m-0 small">Ch√†o <strong>{{ session.get('shortname') }}</strong>! M√¨nh l√† tr·ª£ l√Ω AI. M√¨nh ƒë√£ ƒë·ªçc hi·ªÉu to√†n b·ªô t√†i li·ªáu n√†y.</p>
                    <div class="mt-2 pt-2 border-top">
                        <p class="small text-muted mb-1">G·ª£i √Ω:</p>
                        <button onclick="sendQuick('T√≥m t·∫Øt t√†i li·ªáu n√†y')" class="btn btn-xs btn-outline-primary rounded-pill mb-1" style="font-size: 0.75rem;">üìù T√≥m t·∫Øt √Ω ch√≠nh</button>
                        <button onclick="sendQuick('5 c√¢u h·ªèi √¥n t·∫≠p')" class="btn btn-xs btn-outline-primary rounded-pill mb-1" style="font-size: 0.75rem;">‚ùì ƒê·∫∑t c√¢u h·ªèi √¥n t·∫≠p</button>
                        <button onclick="sendQuick('Quy tr√¨nh n√†y √°p d·ª•ng khi n√†o?')" class="btn btn-xs btn-outline-primary rounded-pill mb-1" style="font-size: 0.75rem;">üí° ·ª®ng d·ª•ng th·ª±c t·∫ø</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3 bg-light border-top">
            <button id="btn-take-quiz" class="btn btn-warning w-100 fw-bold rounded-pill shadow-sm mb-3" onclick="openQuizModal()" disabled>
                <i class="fas fa-lock me-2"></i> Ho√†n th√†nh b√†i h·ªçc ƒë·ªÉ m·ªü Test
            </button>

            <div class="input-group">
                <input type="text" id="user-input" class="form-control border-end-0 rounded-start-pill ps-3 bg-white" placeholder="H·ªèi Titan v·ªÅ t√†i li·ªáu..." onkeydown="if(event.key==='Enter') sendMessage()">
                <button class="btn btn-white border border-start-0 rounded-end-pill" onclick="sendMessage()">
                    <i class="fas fa-paper-plane text-primary"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quizModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-file-signature me-2"></i>B√†i ki·ªÉm tra: {{ material.FileName }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="alert alert-warning border-0 rounded-0 m-0 d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                <div>
                    <strong>Quy ƒë·ªãnh li√™m ch√≠nh h·ªçc thu·∫≠t:</strong><br>
                    Vui l√≤ng tr·∫£ l·ªùi b·∫±ng ch√≠nh ki·∫øn th·ª©c b·∫°n ƒë√£ h·ªçc. <br>
                    <span class="text-danger fw-bold">H·∫°n ch·∫ø s·ª≠ d·ª•ng ChatGPT/Google ƒë·ªÉ sao ch√©p ƒë√°p √°n.</span>
                    AI s·∫Ω ph√°t hi·ªán n·∫øu c√¢u tr·∫£ l·ªùi qu√° gi·ªëng vƒÉn m·∫´u.
                </div>
            </div>

            <div class="modal-body bg-light p-4" id="quiz-body">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">ƒêang t·∫£i ƒë·ªÅ thi t·ª´ ng√¢n h√†ng c√¢u h·ªèi...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success rounded-pill px-4 fw-bold" onclick="submitQuiz()" id="btn-submit-quiz" disabled>N·ªôp b√†i</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
    // --- 1. C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ---
    const pdfUrl = "{{ material.WebPath }}";
    const materialId = {{ material.MaterialID }};
    const userCode = "{{ session.get('user_code') }}";
    const userName = "{{ session.get('shortname') }}";
    
    let pdfDoc = null,
        pageNum = {{ material.last_page or 1 }},
        pageRendering = false,
        pageNumPending = null,
        scale = 1.3, // T·ª∑ l·ªá zoom m·∫∑c ƒë·ªãnh
        canvas = document.getElementById('the-canvas'),
        ctx = canvas.getContext('2d');
    
    // Bi·∫øn l∆∞u tr·ªØ cho Quiz
    let quizData = [];
    let userAnswers = {};

    // --- 2. B·∫¢O M·∫¨T (CH·ªêNG IN & CLICK PH·∫¢I) ---
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.addEventListener('keydown', function(e) {
        // Ch·∫∑n Ctrl+P (Print) v√† Ctrl+S (Save)
        if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 's')) {
            e.preventDefault();
            Swal.fire('C·∫£nh b√°o b·∫£o m·∫≠t', 'T√†i li·ªáu n·ªôi b·ªô. Vui l√≤ng kh√¥ng in ho·∫∑c l∆∞u!', 'warning');
        }
    });

    // --- 3. X·ª¨ L√ù HI·ªÇN TH·ªä PDF ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // T·∫£i PDF
    pdfjsLib.getDocument(pdfUrl).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('page_count').textContent = pdfDoc.numPages;
        renderPage(pageNum);
    }).catch(err => {
        console.error("L·ªói PDF:", err);
        Swal.fire('L·ªói t·∫£i t√†i li·ªáu', 'Kh√¥ng t√¨m th·∫•y file ho·∫∑c file b·ªã l·ªói.', 'error');
    });

    // H√†m render t·ª´ng trang
    function renderPage(num) {
        pageRendering = true;
        
        // 3.1. C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô (Progress Circle)
        if (pdfDoc) {
            let percent = Math.round((num / pdfDoc.numPages) * 100);
            document.getElementById('read-percent').textContent = percent + '%';
            document.getElementById('prog-circle').setAttribute('stroke-dasharray', `${percent}, 100`);
            
            // 3.2. Logic M·ªü kh√≥a b√†i ki·ªÉm tra (Unlock Quiz)
            const btnQuiz = document.getElementById('btn-take-quiz');
            // ƒêi·ªÅu ki·ªán: ƒê·ªçc ƒë·∫øn trang cu·ªëi HO·∫∂C ƒë√£ ƒë·ªçc > 90%
            if (num >= pdfDoc.numPages - 1 || percent >= 90) { 
                btnQuiz.disabled = false;
                btnQuiz.innerHTML = '<i class="fas fa-file-signature me-2"></i> L√†m b√†i ki·ªÉm tra';
                btnQuiz.classList.remove('btn-warning');
                btnQuiz.classList.add('btn-success', 'animate__animated', 'animate__pulse', 'animate__infinite');
            }
        }

        // 3.3. G·ªçi API l∆∞u ti·∫øn ƒë·ªô ng·∫ßm
        saveProgress(num);

        // 3.4. V·∫Ω PDF l√™n Canvas
        pdfDoc.getPage(num).then(function(page) {
            var viewport = page.getViewport({scale: scale});
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            var renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            var renderTask = page.render(renderContext);

            // Ch·ªù render xong ƒë·ªÉ v·∫Ω Watermark ƒë√® l√™n
            renderTask.promise.then(function() {
                pageRendering = false;
                
                // --- V·∫º WATERMARK B·∫¢O M·∫¨T ---
                ctx.save();
                ctx.globalAlpha = 0.1; // ƒê·ªô trong su·ªët th·∫•p (m·ªù)
                ctx.font = "bold 30px Arial";
                ctx.fillStyle = "red";
                ctx.rotate(-35 * Math.PI / 180); // Xoay ch√©o
                
                const wmText = `${userCode} - ${userName}`;
                
                // V·∫Ω l·∫∑p l·∫°i k√≠n trang
                for (let x = -300; x < canvas.width; x += 350) {
                    for (let y = -300; y < canvas.height; y += 250) {
                        ctx.fillText(wmText, x, y);
                    }
                }
                ctx.restore();
                // -----------------------------

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });

        // C·∫≠p nh·∫≠t s·ªë trang hi·ªÉn th·ªã
        document.getElementById('page_num').textContent = num;
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    // Chuy·ªÉn trang Next/Prev
    function changePage(offset) {
        if (pageNum + offset >= 1 && pageNum + offset <= pdfDoc.numPages) {
            pageNum += offset;
            queueRenderPage(pageNum);
        }
    }

    // L∆∞u ti·∫øn ƒë·ªô ƒë·ªçc v√†o DB
    function saveProgress(page) {
        fetch('/api/training/progress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ material_id: materialId, page: page })
        });
    }

    // --- 4. X·ª¨ L√ù QUIZ (TR·∫ÆC NGHI·ªÜM + T·ª∞ LU·∫¨N) ---
    
    // M·ªü Modal v√† t·∫£i ƒë·ªÅ
    function openQuizModal() {
        const modal = new bootstrap.Modal(document.getElementById('quizModal'));
        modal.show();
        loadQuiz();
    }

    // T·∫£i danh s√°ch c√¢u h·ªèi
    function loadQuiz() {
        const body = document.getElementById('quiz-body');
        
        fetch('/api/quiz/get', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ material_id: materialId })
        })
        .then(r => r.json())
        .then(questions => {
            quizData = questions;
            userAnswers = {}; // Reset c√¢u tr·∫£ l·ªùi
            
            if (questions.length === 0) {
                body.innerHTML = `<div class="text-center p-4"><i class="fas fa-check-circle text-success fa-3x mb-3"></i><h5>Ch∆∞a c√≥ b√†i ki·ªÉm tra cho t√†i li·ªáu n√†y.</h5><p>S·∫øp ƒë√£ ho√†n th√†nh vi·ªác ƒë·ªçc!</p></div>`;
                document.getElementById('btn-submit-quiz').style.display = 'none';
                return;
            }
            
            let html = '';
            questions.forEach((q, index) => {
                // Ki·ªÉm tra lo·∫°i c√¢u h·ªèi: N·∫øu OptionA c√≥ d·ªØ li·ªáu -> Tr·∫Øc nghi·ªám, ng∆∞·ª£c l·∫°i -> T·ª± lu·∫≠n
                const isMCQ = q.OptionA && q.OptionA.trim() !== "";
                
                html += `
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold text-primary mb-3">
                            <span class="badge bg-primary me-2">C√¢u ${index + 1}</span> 
                            ${q.Content}
                        </h6>`;
                
                if (isMCQ) {
                    // Render Tr·∫Øc nghi·ªám (Radio buttons)
                    html += `
                        <div class="mt-2">
                            ${renderOption(q.ID, 'A', q.OptionA)}
                            ${renderOption(q.ID, 'B', q.OptionB)}
                            ${renderOption(q.ID, 'C', q.OptionC)}
                            ${renderOption(q.ID, 'D', q.OptionD)}
                        </div>`;
                } else {
                    // Render T·ª± lu·∫≠n (Textarea)
                    html += `
                        <div class="mt-2">
                            <textarea class="form-control bg-white" rows="4" 
                                placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..." 
                                oninput="inputText(this, ${q.ID})"></textarea>
                            <small class="text-muted fst-italic mt-2 d-block"><i class="fas fa-pen-fancy me-1"></i> Tr·∫£ l·ªùi t·ª± lu·∫≠n (AI s·∫Ω ch·∫•m ƒëi·ªÉm)</small>
                        </div>`;
                }

                html += `</div></div>`;
            });
            body.innerHTML = html;
            document.getElementById('btn-submit-quiz').disabled = false;
        });
    }

    // Helper render ƒë√°p √°n tr·∫Øc nghi·ªám
    function renderOption(qId, key, text) {
        if (!text) return '';
        return `
        <div class="form-check mb-2 p-3 border rounded-3 hover-bg-light cursor-pointer" onclick="document.getElementById('opt_${qId}_${key}').click()">
            <input class="form-check-input" type="radio" name="q_${qId}" id="opt_${qId}_${key}" value="${key}" onchange="selectAnswer(${qId}, '${key}')">
            <label class="form-check-label w-100 cursor-pointer" for="opt_${qId}_${key}">
                <strong>${key}.</strong> ${text}
            </label>
        </div>`;
    }

    // L∆∞u ƒë√°p √°n user ch·ªçn/nh·∫≠p
    function selectAnswer(qId, val) { userAnswers[qId] = val; }
    function inputText(el, qId) { userAnswers[qId] = el.value.trim(); }

    // N·ªôp b√†i
    function submitQuiz() {
        // Validate: Ph·∫£i l√†m h·∫øt
        if (Object.keys(userAnswers).length < quizData.length) {
            Swal.fire('Ch∆∞a l√†m xong', 'S·∫øp vui l√≤ng tr·∫£ l·ªùi h·∫øt c√°c c√¢u h·ªèi.', 'warning');
            return;
        }

        // Disable n√∫t ƒë·ªÉ tr√°nh spam
        const btn = document.getElementById('btn-submit-quiz');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI ƒëang ch·∫•m...';

        // G·ª≠i v·ªÅ Server
        fetch('/api/quiz/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ material_id: materialId, answers: userAnswers })
        })
        .then(r => r.json())
        .then(res => {
            if (res.passed) {
                Swal.fire({
                    title: 'ƒê·∫°t y√™u c·∫ßu! üéâ',
                    html: `L·∫ßn thi th·ª© <b>${res.attempt}</b>.<br>ƒêi·ªÉm: <b>${res.score}/${res.total}</b>.<br>ƒê√£ ghi nh·∫≠n ho√†n th√†nh!`,
                    icon: 'success'
                }).then(() => location.reload());
            } else {
                Swal.fire({
                    title: 'Ch∆∞a ƒë·∫°t',
                    html: `L·∫ßn thi th·ª© <b>${res.attempt}</b>.<br>ƒêi·ªÉm: <b>${res.score}/${res.total}</b>.<br>B·∫°n c·∫ßn ƒë√∫ng √≠t nh·∫•t 4/5 c√¢u.<br><br><b>H·ªá th·ªëng s·∫Ω ƒë·ªïi 1 c√¢u h·ªèi m·ªõi trong l·∫ßn thi sau.</b> H√£y √¥n l·∫°i b√†i k·ªπ h∆°n!`,
                    icon: 'warning'
                });
                // Reset n√∫t n·ªôp b√†i
                btn.disabled = false;
                btn.innerHTML = 'N·ªôp b√†i';
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire('L·ªói', 'C√≥ l·ªói x·∫£y ra khi ch·∫•m b√†i.', 'error');
            btn.disabled = false;
            btn.innerHTML = 'N·ªôp b√†i';
        });
    }

    // --- 5. CHAT LOGIC (TITAN TUTOR) ---
    function sendQuick(text) {
        document.getElementById('user-input').value = text;
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        // Hi·ªán tin nh·∫Øn user
        addBubble('user', text);
        input.value = '';
        
        // Hi·ªán typing
        const typingId = addBubble('bot', '<i class="fas fa-ellipsis-h fa-beat"></i>');

        try {
            const res = await fetch('/api/library/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    material_id: materialId, 
                    question: text 
                })
            });
            const data = await res.json();
            
            document.getElementById(typingId).remove();
            addBubble('bot', data.text);

            // N·∫øu AI tr·∫£ v·ªÅ trang -> Jump t·ªõi trang ƒë√≥
            if (data.page) {
                pageNum = data.page;
                queueRenderPage(pageNum);
            }

        } catch (e) {
            console.error(e);
            document.getElementById(typingId).remove();
            addBubble('bot', '‚ùå L·ªói k·∫øt n·ªëi AI.');
        }
    }

    function addBubble(role, htmlContent) {
        const history = document.getElementById('chat-history');
        const id = 'msg-' + Date.now();
        
        const align = role === 'user' ? 'justify-content-end' : '';
        const bg = role === 'user' ? 'bg-primary text-white' : 'bg-white border';
        
        const html = `
        <div class="d-flex mb-3 ${align}" id="${id}">
            <div class="${bg} p-3 rounded-3 shadow-sm" style="max-width: 90%; font-size: 0.9rem;">
                ${htmlContent}
            </div>
        </div>`;
        
        history.insertAdjacentHTML('beforeend', html);
        history.scrollTop = history.scrollHeight;
        return id;
    }
</script>
{% endblock %}