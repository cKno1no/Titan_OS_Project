{% extends "base.html" %}

{% block title %}Dashboard Thời gian Thực | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* KPI CARDS */
    .kpi-card {
        background: var(--card-bg); border-radius: 20px; padding: 25px;
        box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        height: 100%; display: flex; flex-direction: column; justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s; border-left: 6px solid transparent;
    }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
    
    .kpi-title { color: var(--secondary); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
    .kpi-value { color: var(--text-dark); font-size: 2rem; font-weight: 700; line-height: 1; margin-bottom: 5px; }
    .kpi-unit { font-size: 0.9rem; color: var(--secondary); font-weight: 500; }

    /* Border Colors */
    .border-success { border-left-color: var(--success) !important; }
    .border-warning { border-left-color: var(--warning) !important; }
    .border-primary { border-left-color: var(--primary) !important; }
    .border-danger { border-left-color: var(--danger) !important; }
    
    /* Text Colors */
    .text-primary-custom { color: var(--primary); }
    .text-success-custom { color: var(--success); }
    .text-warning-custom { color: var(--warning); }
    .text-danger-custom { color: var(--danger); }

    /* MAIN CARDS */
    .main-card {
        border: 1px solid var(--border-color); background: var(--card-bg); border-radius: 20px;
        box-shadow: var(--shadow-sm); margin-bottom: 25px; overflow: hidden; height: 100%;
    }
    .card-header-custom {
        padding: 20px 25px; border-bottom: 1px solid var(--border-color); background-color: var(--card-bg);
        font-weight: 700; font-size: 1rem; display: flex; align-items: center; color: var(--text-dark);
    }
    .card-header-custom i { margin-right: 10px; font-size: 1.2rem; }

    /* TABLES */
    .table th { 
        background-color: var(--input-bg) !important; color: var(--secondary);
        font-weight: 600; font-size: 0.8rem; text-transform: uppercase; border-bottom: 2px solid var(--border-color);
        padding: 12px 15px; white-space: nowrap;
    }
    .table td { 
        vertical-align: middle; font-size: 0.9rem; padding: 10px 15px;
        border-bottom: 1px solid var(--border-color); color: var(--text-dark);
    }
    .table-row-link:hover td { background-color: var(--input-bg); cursor: pointer; }

    /* FILTER CARD */
    .filter-card {
        background: var(--card-bg); border-radius: 20px; padding: 20px;
        box-shadow: var(--shadow-sm); margin-bottom: 25px; border: 1px solid var(--border-color);
    }
    .form-select {
        border: 1px solid var(--border-color); background-color: var(--input-bg); border-radius: 16px;
        padding: 12px 15px; font-size: 0.95rem; color: var(--text-dark); box-shadow: none;
    }
    .btn-primary { background-color: var(--primary); border: none; border-radius: 16px; font-weight: 600; padding: 12px; width: 100%; transition: all 0.2s; }
    .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); }

    /* MODAL */
    .modal-content { background-color: var(--card-bg); border-radius: 20px; border: none; }
    .modal-header { background-color: var(--input-bg); border-bottom: 1px solid var(--border-color); padding: 20px 25px; }
    .modal-title { color: var(--text-dark); font-weight: 700; }
    .modal-body { color: var(--text-dark); padding: 0; }
    
    @media (max-width: 768px) {
        .table-responsive { overflow-x: auto; }
        .table th, .table td { white-space: nowrap; }
    }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-chart-line me-2 text-primary"></i> DASHBOARD THỜI GIAN THỰC{% endblock %}
{% block page_sub %}
    <span class="text-primary fw-bold">{{ salesman_name | default('N/A') }}</span> 
    <span class="text-muted fw-normal">({{ selected_salesman | default('N/A') }})</span>
{% endblock %}

{% block header_actions %}
<a href="/logout" class="btn btn-light border shadow-sm text-danger fw-bold"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
{% endblock %}

{% block content %}
    <div class="filter-card">
        <form method="POST" action="/realtime_dashboard" class="row g-3 align-items-center">
            <div class="col-md-4">
                <select name="salesman_filter" id="salesman_filter" class="form-select" {% if not is_admin %} disabled {% endif %}>
                    {% if is_admin %}
                        <option value="">-- Tất cả Nhân viên --</option>
                        {% for user in users %}
                        <option value="{{ user.USERCODE }}" {% if selected_salesman == user.USERCODE %} selected {% endif %}>
                            {{ user.SHORTNAME }} ({{ user.USERCODE }})
                        </option>
                        {% endfor %}
                    {% else %}
                        <option value="{{ selected_salesman }}" selected>
                            {{ salesman_name }} ({{ selected_salesman }})
                        </option>
                    {% endif %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary shadow-sm" {% if not is_admin %} disabled {% endif %}>
                    <i class="fas fa-filter me-2"></i> Lọc Dữ Liệu
                </button>
            </div>
        </form>
    </div>
    
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <a href="/sales_dashboard" class="text-decoration-none">
                <div class="kpi-card border-success">
                    <div class="kpi-title text-success-custom">DOANH SỐ YTD (Đã giao)</div>
                    <div class="kpi-value text-success-custom">
                        {{ kpi_summary.get('Sales_YTD', 0) | format_tr }}
                    </div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="/sales_dashboard" class="text-decoration-none">
                <div class="kpi-card border-warning">
                    <div class="kpi-title text-warning-custom">DOANH SỐ THÁNG NÀY</div>
                    <div class="kpi-value text-warning-custom">
                        {{ kpi_summary.get('Sales_CurrentMonth', 0) | format_tr }}
                    </div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="/sales_dashboard" class="text-decoration-none">
                <div class="kpi-card border-primary">
                    <div class="kpi-title text-primary-custom">DOANH SỐ NĂM TRƯỚC</div>
                    <div class="kpi-value text-primary-custom">
                        {{ kpi_summary.get('Sales_LastYear', 0) | format_tr }}
                    </div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6">
            <a href="/sales_dashboard" class="text-decoration-none">
                <div class="kpi-card border-danger">
                    <div class="kpi-title text-danger-custom">ĐƠN CHỜ GIAO (PO)</div>
                    <div class="kpi-value text-danger-custom">
                        {{ kpi_summary.get('PendingOrdersAmount', 0) | format_tr }}
                    </div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </a>
        </div>
    </div>
    
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="main-card">
                <div class="card-header-custom text-primary-custom">
                    <i class="fas fa-star"></i> TOP 10 Đơn hàng LỚN NHẤT Tháng
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="text-start">Mã ĐH</th>
                                <th class="text-start">Khách hàng</th>
                                <th class="text-end">Giá trị</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in top_orders %}
                            <tr class="table-row-link" onclick="showDrillDown('{{ row.VoucherNo }}')">
                                <td class="text-start font-monospace text-secondary">{{ row.VoucherNo }}</td>
                                <td class="text-start fw-bold text-truncate" style="max-width: 200px;">{{ row.ClientName | default('N/A') }}</td>
                                <td class="text-end fw-bold text-primary-custom">
                                    {{ row.TotalConvertedAmount | format_tr }}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center text-muted p-4">Không có đơn hàng nào trong tháng.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="main-card">
                <div class="card-header-custom text-success-custom">
                    <i class="fas fa-receipt"></i> TOP 10 Báo giá LỚN NHẤT Tháng
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="text-start">Mã BG</th>
                                <th class="text-start">Khách hàng</th>
                                <th class="text-end">Giá trị</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in top_quotes %}
                            <tr class="table-row-link" onclick="showDrillDown('{{ row.VoucherNo }}')">
                                <td class="text-start font-monospace text-secondary">{{ row.VoucherNo }}</td>
                                <td class="text-start fw-bold text-truncate" style="max-width: 200px;">{{ row.ClientName | default('N/A') }}</td>
                                <td class="text-end fw-bold text-success-custom">
                                    {{ row.QuoteAmount | format_tr }}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center text-muted p-4">Không có báo giá nào trong tháng.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="main-card">
                <div class="card-header-custom text-warning-custom">
                    <i class="fas fa-hourglass-half"></i> Đơn hàng CHỜ GIAO (Top 20)
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="text-start">Mã ĐH</th>
                                <th class="text-center">Ngày ĐH</th> 
                                <th class="text-start">Khách hàng</th>
                                <th class="text-end">Giá trị</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in pending_orders %}
                            <tr class="table-row-link" onclick="showDrillDown('{{ row.VoucherNo }}')">
                                <td class="text-start font-monospace text-secondary">{{ row.VoucherNo }}</td> 
                                <td class="text-center small text-muted">{{ row.TranDate | format_date }}</td> 
                                <td class="text-start fw-bold text-truncate" style="max-width: 150px;">{{ row.ClientName | default('N/A') }}</td>
                                <td class="text-end fw-bold text-warning-custom">
                                    {{ row.TotalConvertedAmount | format_tr }}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center text-muted p-4">Không có đơn hàng nào chờ giao.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="main-card">
                <div class="card-header-custom text-danger-custom">
                    <i class="fas fa-truck"></i> Hàng SẮP GIAO (3 Tháng tới)
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="text-start">Mã ĐH</th>
                                <th class="text-start">Mặt hàng</th>
                                <th class="text-center">Ngày Giao</th> 
                                <th class="text-end">SL CL</th>
                                <th class="text-end">Giá trị</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in upcoming_deliveries %}
                            <tr class="table-row-link" onclick="showDrillDown('{{ row.VoucherNo }}')">
                                <td class="text-start font-monospace text-secondary">{{ row.VoucherNo }}</td> 
                                <td class="text-start text-truncate" style="max-width: 150px;">{{ row.InventoryName | default(row.InventoryID) }}</td>
                                <td class="text-center small">{{ row.DeliverDate | format_date }}</td> 
                                <td class="text-end">{{ row.RemainingQuantity | format_number }}</td>
                                <td class="text-end fw-bold text-danger-custom">
                                    {{ row.RemainingValue | format_tr }}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center text-muted p-4">Không có mặt hàng nào sắp giao.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="drilldownModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="drilldownModalTitle">Chi tiết Đơn hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0" id="drilldownModalBody"></div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        // --- HÀM ĐỊNH DẠNG SỐ JS (TRÁNH LỖI NaN) ---
        function formatNumberStandard(value) {
            if (!value && value !== 0) return '0';
            return new Intl.NumberFormat('en-US').format(value);
        }

        function showDrillDown(voucherNo) {
            const modalBody = document.getElementById('drilldownModalBody');
            const modalTitle = document.getElementById('drilldownModalTitle');
            
            modalTitle.innerText = 'Chi tiết: ' + voucherNo;
            modalBody.innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Đang tải...</p></div>';
            
            // Fix: Thêm /sales vào prefix vì sales_lookup_bp có url_prefix='/sales'
            fetch(`/sales/api/get_order_detail_drilldown/${encodeURIComponent(voucherNo)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error || data.length === 0) {
                        modalBody.innerHTML = `<div class="p-4 text-center text-muted">Không tìm thấy chi tiết.</div>`;
                        return;
                    }
                    
                    let tableHtml = '<div class="table-responsive"><table class="table table-striped mb-0">';
                    tableHtml += `<thead><tr>
                                    <th class="text-start ps-4" style="background:var(--input-bg);">Mã hàng</th>
                                    <th class="text-start" style="background:var(--input-bg);">Tên hàng</th>
                                    <th class="text-end" style="background:var(--input-bg);">SL</th>
                                    <th class="text-end pe-4" style="background:var(--input-bg);">Thành tiền</th>
                                  </tr></thead><tbody>`;
                    
                    data.forEach(item => {
                        // Xử lý thành tiền hiển thị dạng full (1,200,000)
                        const rawThanhTien = parseFloat(String(item.ThanhTien || 0).replace(/,/g, ''));
                        const displayThanhTien = formatNumberStandard(rawThanhTien);

                        tableHtml += `<tr>
                                        <td class="text-start ps-4 font-monospace text-primary">${item.InventoryID}</td>
                                        <td class="text-start text-wrap" style="max-width: 300px;">${item.InventoryName || 'N/A'}</td>
                                        <td class="text-end">${item.SoLuong}</td>
                                        <td class="text-end pe-4 fw-bold">${displayThanhTien}</td>
                                      </tr>`;
                    });
                    tableHtml += '</tbody></table></div>';
                    
                    modalBody.innerHTML = tableHtml;
                })
                .catch(error => {
                    modalBody.innerHTML = `<div class="p-4 text-center text-danger">Lỗi kết nối: ${error.message}</div>`;
                });

            var drilldownModal = new bootstrap.Modal(document.getElementById('drilldownModal'));
            drilldownModal.show();
        }
    </script>
{% endblock %}