{% extends "base.html" %}
{% block title %}Ph·ªëi h·ª£p nh·ªãp nh√†ng - ƒê√°nh gi√° 360{% endblock %}

{% block content %}
<style>
    /* UI N√¢ng c·∫•p */
    .user-list-item { cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
    .user-list-item:hover { background-color: #f8f9fa; }
    .user-list-item.active { background-color: #e3f2fd; border-left-color: #0d6efd; font-weight: bold; }
    
    .avatar-sm { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e9ecef; }
    .avatar-lg { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    .score-card { 
        cursor: pointer; transition: all 0.3s; border: 2px solid #e9ecef; border-radius: 12px; 
        filter: grayscale(80%); opacity: 0.6; background: white;
    }
    .score-card:hover { filter: grayscale(0%); opacity: 1; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    
    /* Tr·∫°ng th√°i ƒë∆∞·ª£c ch·ªçn */
    .score-card.active-S { border-color: #198754; filter: grayscale(0%); opacity: 1; background-color: #f0fdf4; transform: scale(1.02); box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.2); }
    .score-card.active-A { border-color: #0d6efd; filter: grayscale(0%); opacity: 1; background-color: #eff6ff; transform: scale(1.02); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2); }
    .score-card.active-B { border-color: #ffc107; filter: grayscale(0%); opacity: 1; background-color: #fffbeb; transform: scale(1.02); box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2); }
    .score-card.active-C { border-color: #fd7e14; filter: grayscale(0%); opacity: 1; background-color: #fff7ed; transform: scale(1.02); box-shadow: 0 0 0 3px rgba(253, 126, 20, 0.2); }
    .score-card.active-D { border-color: #dc3545; filter: grayscale(0%); opacity: 1; background-color: #fef2f2; transform: scale(1.02); box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2); }

    .emoji-img { width: 50px; height: 50px; margin-right: 15px; } /* ƒê·ªÉ d√πng ·∫£nh gif/icon t√πy th√≠ch */
    .emoji-text { font-size: 2.8rem; line-height: 1; margin-right: 15px; }
    .score-letter { font-size: 2.5rem; font-weight: 900; margin-right: 15px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    
    .status-badge { font-size: 0.7rem; padding: 0.2rem 0.5rem; }
</style>

<div class="container-fluid mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold mb-0"><i class="fas fa-handshake"></i> ƒê√°nh Gi√° Kh·∫£ NƒÉng Ph·ªëi H·ª£p</h2>
        <span class="badge bg-secondary fs-6 px-3 py-2"><i class="fas fa-building"></i> Kh·ªëi: {{ current_division }}</span>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="mb-2 text-dark fw-bold"><i class="fas fa-sitemap text-primary"></i> L·ªçc theo ph√≤ng ban</h6>
                    <select id="deptSelect" class="form-select border-primary bg-light" onchange="loadUsers()">
                        <option value="">-- Ch·ªçn b·ªô ph·∫≠n c·∫ßn ƒë√°nh gi√° --</option>
                        {% for d in departments %}
                        <option value="{{ d.Department }}">{{ d.Department }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush" id="userList" style="max-height: 600px; overflow-y: auto;">
                        <li class="list-group-item text-center text-muted py-5">
                            <i class="fas fa-users fa-3x mb-3 text-light"></i><br>
                            Vui l√≤ng ch·ªçn ph√≤ng ban.
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm border-0 h-100" id="scoringArea" style="display: none;">
                <div class="card-header border-0 py-4" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
                    <div class="d-flex align-items-center">
                        <img src="" id="evalTargetAvatar" class="avatar-lg me-3" alt="Avatar">
                        <div class="text-white">
                            <h3 class="mb-1 fw-bold text-uppercase" id="evalTargetFullName">H·ªç V√† T√™n</h3>
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-white text-primary rounded-pill"><i class="fas fa-id-badge"></i> <span id="evalTargetCode">KD000</span></span>
                                <span class="opacity-75"><i class="fas fa-briefcase"></i> <span id="evalTargetJob">Ch·ª©c v·ª•</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-4 bg-light">
                    <div id="alreadyEvaluatedAlert" class="alert alert-success d-none shadow-sm mb-4">
                        <i class="fas fa-check-circle fs-5 me-2"></i> B·∫°n ƒë√£ ƒë√°nh gi√° nh√¢n s·ª± n√†y m·ª©c <b><span id="txtOldScore"></span> ƒëi·ªÉm</b>. B·∫°n c√≥ th·ªÉ ch·ªçn m·ª©c kh√°c ƒë·ªÉ c·∫≠p nh·∫≠t l·∫°i.
                    </div>

                    <h5 class="fw-bold text-dark mb-3">M·ª©c ƒë·ªô h√†i l√≤ng c·ªßa b·∫°n trong th√°ng n√†y:</h5>
                    
                    <div class="row g-2 mb-4">
                        <div class="col-12">
                            <div class="score-card p-2 px-4 d-flex align-items-center" id="card-10" onclick="selectScore(10, 'S')">
                                <div class="emoji-text">ü§©</div>
                                <div class="score-letter text-success">S</div>
                                <div>
                                    <h6 class="mb-1 fw-bold text-dark">Qu√° tuy·ªát v·ªùi! (10ƒë)</h6>
                                    <small class="text-muted">V∆∞·ª£t xa mong ƒë·ª£i, h·ªó tr·ª£ nhi·ªát t√¨nh, gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ xu·∫•t s·∫Øc.</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="score-card p-2 px-4 d-flex align-items-center" id="card-9" onclick="selectScore(9, 'A')">
                                <div class="emoji-text">üòÑ</div>
                                <div class="score-letter text-primary">A</div>
                                <div>
                                    <h6 class="mb-1 fw-bold text-dark">T·ªët, ƒë√∫ng nh∆∞ k·ª≥ v·ªçng (9ƒë)</h6>
                                    <small class="text-muted">L√†m vi·ªác ƒÉn √Ω, ph·∫£n h·ªìi nhanh, ch·∫•t l∆∞·ª£ng c√¥ng vi·ªác ƒë·∫£m b·∫£o.</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="score-card p-2 px-4 d-flex align-items-center" id="card-8" onclick="selectScore(8, 'B')">
                                <div class="emoji-text">üôÇ</div>
                                <div class="score-letter text-warning">B</div>
                                <div>
                                    <h6 class="mb-1 fw-bold text-dark">Kh√°, OK nh∆∞ v·∫≠y t·∫°m ƒë∆∞·ª£c (8ƒë)</h6>
                                    <small class="text-muted">Ho√†n th√†nh tr√≤n vai, ƒë√¥i khi c·∫ßn nh·∫Øc nh·ªü nh·∫π nh∆∞ng kh√¥ng ·∫£nh h∆∞·ªüng ti·∫øn ƒë·ªô.</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="score-card p-2 px-4 d-flex align-items-center" id="card-7" onclick="selectScore(7, 'C')">
                                <div class="emoji-text">üòê</div>
                                <div class="score-letter" style="color: #fd7e14;">C</div>
                                <div>
                                    <h6 class="mb-1 fw-bold text-dark">Ch∆∞a h√†i l√≤ng l·∫Øm (7ƒë)</h6>
                                    <small class="text-muted">Ph·ªëi h·ª£p c√≤n ch·∫≠m, th·ªânh tho·∫£ng sai s√≥t g√¢y ·∫£nh h∆∞·ªüng ƒë·∫øn c√¥ng vi·ªác chung.</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="score-card p-2 px-4 d-flex align-items-center" id="card-6" onclick="selectScore(6, 'D')">
                                <div class="emoji-text">üòû</div>
                                <div class="score-letter text-danger">D</div>
                                <div>
                                    <h6 class="mb-1 fw-bold text-dark">Kh√¥ng tho·∫£i m√°i, b·∫•t m√£n! (6ƒë)</h6>
                                    <small class="text-muted">Th√°i ƒë·ªô kh√¥ng t·ªët, ch·∫≠m tr·ªÖ li√™n t·ª•c, ƒë√πn ƒë·∫©y tr√°ch nhi·ªám.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold text-dark mb-2">L·ªùi nh·∫Øn g·ª≠i (Kh√¥ng b·∫Øt bu·ªôc)</h6>
                    <textarea id="evalNote" class="form-control border-0 shadow-sm rounded-3 p-3" rows="2" placeholder="V√≠ d·ª•: C·∫£m ∆°n b·∫°n ƒë√£ h·ªó tr·ª£ m√¨nh ƒë∆°n h√†ng g·∫•p h√¥m th·ª© 6 nh√©!"></textarea>
                    
                    <input type="hidden" id="currentScore" value="">
                </div>
                
                <div class="card-footer bg-white border-top p-3 text-end">
                    <button class="btn btn-primary fw-bold px-5 rounded-pill shadow-sm" onclick="submitReview()">
                        <i class="fas fa-check-circle me-1"></i> GHI NH·∫¨N ƒê√ÅNH GI√Å
                    </button>
                </div>
            </div>

            <div id="welcomeArea" class="h-100 d-flex flex-column justify-content-center align-items-center text-muted bg-white rounded shadow-sm border" style="min-height: 500px;">
                <i class="fas fa-comments-dollar fa-5x mb-3 text-primary opacity-50"></i>
                <h4 class="fw-bold">H·ªá th·ªëng ƒê√°nh gi√° 360¬∞</h4>
                <p>Ch·ªçn m·ªôt ƒë·ªìng nghi·ªáp b√™n tr√°i ƒë·ªÉ g·ª≠i l·ªùi c·∫£m ∆°n ho·∫∑c g√≥p √Ω.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let globalUsersData = []; 

    function loadUsers() {
        const dept = document.getElementById('deptSelect').value;
        const userList = document.getElementById('userList');
        
        if(!dept) {
            userList.innerHTML = '<li class="list-group-item text-center text-muted py-5">Vui l√≤ng ch·ªçn ph√≤ng ban</li>';
            return;
        }

        userList.innerHTML = '<li class="list-group-item text-center py-5"><div class="spinner-border text-primary"></div></li>';

        fetch(`{{ url_for('kpi_evaluation_bp.get_users_by_dept') }}?dept=${encodeURIComponent(dept)}`)
            .then(res => res.json())
            .then(data => {
                globalUsersData = data;
                userList.innerHTML = '';
                if(data.length === 0) {
                    userList.innerHTML = '<li class="list-group-item text-center text-muted py-5">Kh√¥ng c√≥ nh√¢n s·ª± n√†o.</li>';
                    return;
                }
                
                data.forEach((u, index) => {
                    // [FIX] B·∫Øt l·ªói NaN (Not a Number)
                    let statusBadge = '';
                    if(u.EvaluatedScore !== null && !isNaN(u.EvaluatedScore)) {
                        statusBadge = `<span class="badge bg-success rounded-pill status-badge"><i class="fas fa-check"></i> ƒê√£ ch·∫•m ${u.EvaluatedScore}ƒë</span>`;
                    }

                    const li = document.createElement('li');
                    li.className = 'list-group-item user-list-item d-flex align-items-center py-3';
                    li.innerHTML = `
                        <img src="${u.AvatarUrl}" class="avatar-sm me-3" onerror="this.src='https://ui-avatars.com/api/?background=random&name=User'">
                        <div class="flex-grow-1">
                            <div class="fw-bold text-dark" style="font-size: 0.95rem;">${u.FullName || u.SHORTNAME}</div>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small class="text-muted">${u.USERCODE}</small>
                                ${statusBadge}
                            </div>
                        </div>
                    `;
                    li.onclick = function() {
                        document.querySelectorAll('.user-list-item').forEach(el => el.classList.remove('active'));
                        this.classList.add('active');
                        openScoring(index); 
                    };
                    userList.appendChild(li);
                });
            });
    }

    function openScoring(index) {
        const user = globalUsersData[index];
        
        // ·∫®n Welcome, Hi·ªán Form
        document.getElementById('welcomeArea').classList.replace('d-flex', 'd-none');
        document.getElementById('scoringArea').style.display = 'block';
        
        // ƒê·ªï th√¥ng tin Header
        document.getElementById('evalTargetCode').innerText = user.USERCODE;
        document.getElementById('evalTargetFullName').innerText = user.FullName || user.SHORTNAME;
        document.getElementById('evalTargetJob').innerText = user.JobTitle || 'Nh√¢n vi√™n';
        document.getElementById('evalTargetAvatar').src = user.AvatarUrl;
        
        // Reset form
        document.getElementById('currentScore').value = '';
        document.getElementById('evalNote').value = '';
        document.querySelectorAll('.score-card').forEach(el => el.className = el.className.replace(/active-[A-Z]/g, '').trim() + ' score-card p-2 px-4 d-flex align-items-center');
        document.getElementById('alreadyEvaluatedAlert').classList.add('d-none');

        // [FIX] KI·ªÇM TRA ƒê√É CH·∫§M CH∆ØA B·∫∞NG LOGIC KH√îNG L·∫§Y NaN
        if(user.EvaluatedScore !== null && !isNaN(user.EvaluatedScore)) {
            document.getElementById('alreadyEvaluatedAlert').classList.remove('d-none');
            document.getElementById('txtOldScore').innerText = user.EvaluatedScore;
            
            // T·ª± ƒë·ªông select l·∫°i card c≈©
            let letter = 'D';
            if(user.EvaluatedScore == 10) letter = 'S';
            else if(user.EvaluatedScore >= 9) letter = 'A';
            else if(user.EvaluatedScore >= 8) letter = 'B';
            else if(user.EvaluatedScore >= 7) letter = 'C';
            
            selectScore(user.EvaluatedScore, letter);
        }
    }

    function selectScore(score, letter) {
        document.getElementById('currentScore').value = score;
        
        document.querySelectorAll('.score-card').forEach(el => {
            el.className = el.className.replace(/active-[A-Z]/g, '').trim() + ' score-card p-2 px-4 d-flex align-items-center';
        });
        
        document.getElementById('card-' + score).classList.add('active-' + letter);
    }

    function submitReview() {
        const targetUser = document.getElementById('evalTargetCode').innerText;
        const score = document.getElementById('currentScore').value;
        const note = document.getElementById('evalNote').value;

        if(!score) {
            Swal.fire('Thi·∫øu th√¥ng tin!', 'Vui l√≤ng ch·ªçn m·ªôt m·ª©c ƒë·ªô (S, A, B, C, D) tr∆∞·ªõc khi g·ª≠i.', 'warning');
            return;
        }

        Swal.fire({ title: 'ƒêang l∆∞u ƒë√°nh gi√°...', didOpen: () => { Swal.showLoading(); } });

        fetch('{{ url_for("kpi_evaluation_bp.submit_peer_review") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target_user: targetUser, score: score, note: note })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                Swal.fire('Th√†nh c√¥ng!', 'ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n. C·∫£m ∆°n b·∫°n!', 'success').then(() => {
                    loadUsers(); 
                    // Quay v·ªÅ Welcome Screen
                    document.getElementById('welcomeArea').classList.replace('d-none', 'd-flex');
                    document.getElementById('scoringArea').style.display = 'none';
                });
            } else {
                Swal.fire('L·ªói', data.message, 'error');
            }
        });
    }
</script>
{% endblock %}