{% extends "base.html" %}

{% block title %}Báo cáo Chi tiết Công nợ Quá hạn | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* CONTAINER & HEADER */
    .container-main { max-width: 1400px; margin: auto; padding: 20px; }

    /* CARD STYLES */
    .main-card {
        border: none; background: var(--card-bg); border-radius: 20px;
        box-shadow: var(--shadow-sm); margin-bottom: 25px; overflow: hidden;
        border: 1px solid var(--border-color);
    }
    
    .card-header-custom {
        padding: 20px 25px; border-bottom: 1px solid var(--border-color); background-color: var(--card-bg);
        display: flex; justify-content: space-between; align-items: center;
    }

    /* TABLE DETAIL */
    .table-detail th { 
        position: sticky !important; top: 0; z-index: 10; 
        background-color: var(--input-bg) !important; 
        color: var(--secondary) !important; 
        font-weight: 700; text-align: center !important; font-size: 0.8rem;
        border-bottom: 2px solid var(--border-color); white-space: nowrap;
        padding: 15px 10px;
    }
    .table-detail td { 
        vertical-align: middle; text-align: right; font-size: 0.9rem; 
        padding: 10px; border-bottom: 1px solid var(--border-color); color: var(--text-dark);
    }
    .table-detail tbody tr:hover td { background-color: var(--input-bg); }
    
    /* COLUMNS */
    .text-start { text-align: left !important; }
    .text-center { text-align: center !important; }
    
    /* HIGHLIGHTS */
    .debt-overdue { color: var(--danger); font-weight: 700; background-color: rgba(227, 26, 26, 0.1); padding: 4px 8px; border-radius: 6px; }
    .debt-current { color: var(--success); font-weight: 600; }
    
    /* Subtotal Row */
    .subtotal-row td { background-color: var(--input-bg) !important; font-weight: 800; font-size: 1.1rem !important; color: var(--text-dark); border-top: 2px solid var(--border-color); }
    
    /* TOGGLE SWITCH */
    .form-check-input { background-color: var(--input-bg); border-color: var(--border-color); cursor: pointer; }
    .form-check-input:checked { background-color: var(--danger); border-color: var(--danger); }
    .toggle-label { font-weight: 600; color: var(--text-dark); font-size: 0.9rem; }

    /* AUTOCOMPLETE */
    .search-container { position: relative; }
    .search-results-dropdown { 
        width: 100%; border-radius: 12px; border: 1px solid var(--primary);
        outline: none; display: none; position: absolute;
        z-index: 1000; margin-top: 5px; background-color: var(--card-bg); color: var(--text-dark);
        box-shadow: var(--shadow-md);
    }

    /* DataTables Theme Override */
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_info { color: var(--secondary) !important; padding: 10px; }
    .dataTables_wrapper .dataTables_paginate .paginate_button { color: var(--secondary) !important; }
    .dataTables_wrapper .dataTables_filter input { background-color: var(--input-bg); color: var(--text-dark); border: 1px solid var(--border-color); }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-file-invoice-dollar me-2 text-primary"></i> CHI TIẾT CÔNG NỢ QUÁ HẠN{% endblock %}
{% block page_sub %}Theo dõi chi tiết hóa đơn quá hạn của từng khách hàng.{% endblock %}

{% block header_actions %}
<a href="{{ url_for('kpi_bp.ar_aging_dashboard') }}" class="btn btn-back"><i class="fas fa-arrow-left me-2"></i>Dashboard Tổng</a>
{% endblock %}

{% block content %}
    <div class="alert alert-danger d-flex justify-content-between align-items-center mb-4 rounded-4 shadow-sm" style="background-color: rgba(227, 26, 26, 0.1); border: 1px solid rgba(227, 26, 26, 0.2); color: var(--danger);">
        <h5 class="mb-0 fw-bold">
            <i class="fas fa-exclamation-triangle me-2"></i> Tổng Nợ Quá Hạn: 
            <span style="font-size: 1.2em;">{{ total_overdue | format_tr }}</span>
        </h5>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="toggleOverdue">
            <label class="form-check-label toggle-label text-danger" for="toggleOverdue">Chỉ hiện Nợ Quá Hạn</label>
        </div>
    </div>

    <div class="main-card mb-4">
        <div class="card-body-custom" style="padding: 25px;">
            <form method="POST" action="{{ url_for('kpi_bp.ar_aging_detail_dashboard') }}" class="row g-3 align-items-end">
                
                <div class="col-md-4 search-container">
                    <label for="kh_search_input" class="form-label small text-muted text-uppercase fw-bold">Chọn Khách hàng</label>
                    <input type="text" id="kh_search_input" name="kh_search_text" placeholder="Gõ Mã/Tên Khách hàng..." class="form-control"
                           value="{{ customer_name_filter | default('') }}">
                    <input type="hidden" name="customer_id" id="kh_ma_selected">
                    <select id="kh_search_results" class="form-select search-results-dropdown" size="5" onchange="selectClient('kh_search_results', 'kh_search_input', 'kh_ma_selected')"></select>
                </div>
                
                {% if is_admin_or_manager %}
                <div class="col-md-3">
                     <label for="salesman_filter" class="form-label small text-muted text-uppercase fw-bold">Lọc theo NVKD</label>
                     <select name="salesman_filter" id="salesman_filter" class="form-select">
                        <option value="">-- Tất cả NVKD --</option>
                        {% for user in salesman_list %}
                        <option value="{{ user.USERCODE }}" 
                                {% if filter_salesman_id == user.USERCODE %} selected {% endif %}>
                            {{ user.SHORTNAME }} ({{ user.USERCODE }})
                        </option>
                        {% endfor %}
                     </select>
                </div>
                {% endif %}
                
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100 fw-bold shadow-sm" style="border-radius: 12px; padding: 10px;">
                        <i class="fas fa-filter me-2"></i> Lọc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="main-card">
        <div class="card-body-custom p-0">
            <div class="table-responsive">
                <table id="ar-aging-detail-table" class="table table-hover mb-0 table-detail">
                    <thead>
                        <tr>
                            <th style="width: 50px;">STT</th>
                            <th class="text-start">Tên Khách hàng</th>
                            <th>Số Hóa Đơn</th>
                            <th>Ngày CT</th>
                            <th data-toggle="tooltip" title="Số ngày Quá Hạn (Âm nếu còn trong hạn)">Số ngày Q.H</th>
                            <th>Nợ Quá Hạn</th>
                            <th>Nợ Trong Hạn</th>
                            <th class="text-start">NVKD</th>
                            <th class="text-start">Mã KH</th>
                        </tr>
                    </thead>
                    <tbody id="aging-detail-body">
                        {% for row in aging_details %}
                        <tr data-is-overdue="{{ 'true' if row.Debt_Total_Overdue > 0 else 'false' }}">
                            <td class="text-center"></td> 
                            <td class="text-start fw-bold text-truncate" style="max-width: 250px;" title="{{ row.ObjectName }}">{{ row.ObjectName | default(row.ShortObjectName) | default('N/A') }}</td>
                            <td class="text-center font-monospace text-primary">{{ row.InvoiceNo }}</td>
                            <td class="text-center small">{{ row.VoucherDate | format_date }}</td>
                            
                            <td class="text-center">
                                {% if row.OverdueDays > 0 %}
                                    <span class="badge bg-danger">{{ row.OverdueDays }}</span>
                                {% else %}
                                    <span class="text-success fw-bold">{{ row.OverdueDays }}</span>
                                {% endif %}
                            </td>
                            
                            <td class="text-end">
                                {% if row.Debt_Total_Overdue > 0 %}
                                    <span class="debt-overdue">{{ row.Debt_Total_Overdue | format_number }}</span>
                                {% else %} - {% endif %}
                            </td>
                            
                            <td class="text-end debt-current">{{ row.Debt_In_Term | format_number }}</td>
                            
                            <td class="text-start small">{{ row.SalesManID | default('N/A') }}</td> 
                            <td class="text-start small font-monospace">{{ row.ObjectID }}</td>
                        </tr>
                        {% else %}
                        <tr class="data-table-empty">
                            <td colspan="9" class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>
                                Không tìm thấy chi tiết công nợ theo tiêu chí lọc.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="subtotal-row">
                            <td colspan="5" class="text-end text-uppercase text-secondary" style="font-size: 0.9rem;">Tổng Nợ Quá Hạn:</td>
                            <td colspan="4" class="text-danger fw-bold" style="font-size: 1.2rem;">{{ total_overdue | format_tr }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>

    <script>
        let arAgingTable;

        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); };
        }
        
        // HÀM TÌM KIẾM KHÁCH HÀNG (Autocomplete)
        function timKhachHangAutocomplete(term, resultsDropdown) {
             const cleanedTerm = String(term || '').trim();
             if (cleanedTerm.length < 2) { resultsDropdown.hide().empty(); return; }
             
             resultsDropdown.empty().show();

             fetch(`/sales/api/khachhang/${cleanedTerm}`)
                 .then(response => response.ok ? response.json() : [])
                 .then(data => {
                     if (data && data.length > 0) {
                         data.forEach(kh => {
                             const displayName = kh.LongName || kh.FullName || kh.ID;
                             const option = `<option value="${kh.ID}" data-fullname="${displayName}">${displayName} (${kh.ID})</option>`;
                             resultsDropdown.append(option);
                         });
                         resultsDropdown.attr('size', Math.min(data.length, 5) + 1);
                     } else { resultsDropdown.hide(); }
                 })
                 .catch(() => resultsDropdown.hide());
        }
        
        window.selectClient = function(dropdownId, inputId, hiddenId) {
             const dropdown = $(`#${dropdownId}`);
             const selectedOption = dropdown.find('option:selected');
             
             if (selectedOption.length) {
                 $(`#${hiddenId}`).val(selectedOption.val());
                 $(`#${inputId}`).val(selectedOption.data('fullname'));
                 dropdown.hide();
                 $(`#salesman_filter`).closest('form').submit(); // Auto submit
             }
        };

        $(document).ready(function() {
            const khSearchInput = $('#kh_search_input');
            const khSearchResults = $('#kh_search_results');
            
            khSearchInput.on('input', debounce(function() {
                 timKhachHangAutocomplete(khSearchInput.val(), khSearchResults);
            }, 300));
            
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.search-container').length) khSearchResults.hide();
            });

            // DATA TABLE INIT
            const hasDataRows = $('#aging-detail-body tr:not(.data-table-empty)').length > 0;
            
            if (hasDataRows) {
                arAgingTable = $('#ar-aging-detail-table').DataTable({
                    "paging": true, "pageLength": 25, "lengthChange": true, "searching": true, 
                    "ordering": true, "info": true, "order": [[4, 'desc']], 
                    "language": { "search": "Lọc nhanh:", "paginate": { "next": ">", "previous": "<" } },
                    "columnDefs": [
                        { "width": "4%", "targets": 0, "orderable": false, "className": "text-center",
                          "render": function (data, type, row, meta) { return meta.row + meta.settings._iDisplayStart + 1; } }
                    ]
                });
            
                // Custom Filter Overdue
                $.fn.dataTable.ext.search.push(
                    function(settings, data, dataIndex) {
                        if (settings.nTable.id !== 'ar-aging-detail-table') return true;
                        if (!$('#toggleOverdue').is(':checked')) return true;
                        const rowNode = arAgingTable.row(dataIndex).node();
                        return $(rowNode).data('is-overdue') === true;
                    }
                );

                $('#toggleOverdue').on('change', function() { arAgingTable.draw(); });
            }
        });
    </script>
{% endblock %}