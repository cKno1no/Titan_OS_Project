{% extends "base.html" %}

{% block title %}Dashboard Hiệu Suất Bán Hàng | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* KPI CARDS */
    .kpi-card {
        background: var(--card-bg); border-radius: var(--card-radius); padding: 20px;
        box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        height: 100%; display: flex; align-items: center; transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-5px); border-color: var(--primary); }
    
    .kpi-icon-box {
        width: 60px; height: 60px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin-right: 20px; font-size: 1.6rem; flex-shrink: 0;
    }
    
    .icon-target { background-color: rgba(5, 205, 153, 0.1); color: var(--success); }
    .icon-ytd { background-color: var(--input-bg); color: var(--primary); }
    .icon-pending { background-color: rgba(227, 26, 26, 0.1); color: var(--danger); }

    .kpi-content { flex-grow: 1; }
    .kpi-label { color: var(--secondary); font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-value { color: var(--text-dark); font-size: 1.8rem; font-weight: 800; line-height: 1; }
    .kpi-unit { font-size: 0.85rem; color: var(--secondary); margin-top: 4px; font-weight: 500; }

    /* MAIN CARD & TABLE */
    .main-card {
        border: none; background: var(--card-bg); border-radius: var(--card-radius);
        box-shadow: var(--shadow-sm); margin-bottom: 25px; overflow: hidden;
        border: 1px solid var(--border-color);
    }
    .card-header-custom {
        padding: 20px 25px; border-bottom: 1px solid var(--border-color);
        font-weight: 700; color: var(--text-dark); font-size: 1.1rem;
        display: flex; align-items: center; background-color: var(--card-bg);
    }
    .card-header-custom i { color: var(--primary); margin-right: 10px; font-size: 1.2rem; }
    .card-body-custom { padding: 0; }

    /* Table Styles */
    .table { margin-bottom: 0; width: 100%; border-collapse: separate; border-spacing: 0; }
    .table th { 
        background-color: var(--input-bg) !important; color: var(--secondary) !important;
        font-weight: 700; font-size: 0.8rem; text-transform: uppercase; text-align: center;
        padding: 15px 10px; border-bottom: 2px solid var(--border-color);
        vertical-align: middle; white-space: nowrap;
        position: sticky; top: 0; z-index: 10;
    }
    .table td { 
        vertical-align: middle; font-size: 0.9rem; padding: 12px 10px;
        border-bottom: 1px solid var(--border-color); color: var(--text-dark);
    }
    .table tbody tr:hover td { background-color: var(--input-bg); cursor: pointer; }

    /* Column Specifics */
    .col-id { width: 8%; text-align: center; font-weight: 600; color: var(--secondary); }
    .col-name { width: 18%; text-align: left !important; font-weight: 700; color: var(--primary); }
    .col-data { width: 12%; text-align: right !important; }
    .col-detail { width: 5%; text-align: center; }
    
    .data-amount { font-weight: 700; color: var(--text-dark); }
    .pending-amount { color: var(--danger); font-weight: 700; }

    /* Modern Progress Bar */
    .progress-cell { 
        position: relative; padding: 8px 10px 8px 0 !important; 
        text-align: right; vertical-align: middle;
    }
    .progress-wrapper {
        position: relative; height: 24px; width: 100%;
        background-color: var(--input-bg); border-radius: 6px; overflow: hidden;
        display: flex; align-items: center; border: 1px solid var(--border-color);
    }
    .progress-bar-fill {
        height: 100%; border-radius: 4px; transition: width 0.6s ease;
    }
    .progress-text {
        position: absolute; right: 8px; font-size: 0.8rem; font-weight: 700;
        color: var(--text-dark); z-index: 2; line-height: 24px;
    }
    .text-white-shadow { color: white; text-shadow: 0 0 3px rgba(0,0,0,0.6); }

    /* Responsive */
    @media (max-width: 992px) {
        .table-responsive { overflow-x: auto; border-radius: 12px; }
        .table th, .table td { white-space: nowrap; padding: 10px 8px; }
    }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-chart-line me-2 text-primary"></i> BÁO CÁO HIỆU SUẤT BÁN HÀNG ({{ current_year }}){% endblock %}
{% block page_sub %}Theo dõi chỉ tiêu doanh số, thực đạt và đơn hàng tồn đọng.{% endblock %}

{% block header_actions %}
<a href="/" class="btn btn-back"><i class="fas fa-home me-2"></i>Portal</a>
{% endblock %}

{% block content %}
    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="kpi-card">
                <div class="kpi-icon-box icon-target"><i class="fas fa-bullseye"></i></div>
                <div class="kpi-content">
                    <div class="kpi-label">Tổng Đăng Ký (Mục tiêu)</div>
                    <div class="kpi-value">{{ total_registered_sales | format_tr }}</div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="kpi-card">
                <div class="kpi-icon-box icon-ytd"><i class="fas fa-chart-line"></i></div>
                <div class="kpi-content">
                    <div class="kpi-label">Tổng YTD (Thực hiện)</div>
                    <div class="kpi-value">{{ total_ytd_sales | format_tr }}</div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-12">
            <div class="kpi-card">
                <div class="kpi-icon-box icon-pending"><i class="fas fa-hourglass-half"></i></div>
                <div class="kpi-content">
                    <div class="kpi-label">Đơn Hàng Chờ Giao (PO)</div>
                    <div class="kpi-value">{{ total_pending_orders_amount | format_tr }}</div>
                    <div class="kpi-unit">Triệu VNĐ ({{ total_orders | format_number }} Đơn)</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-card">
        <div class="card-header-custom">
            <span><i class="fas fa-users me-2"></i> Phân tích Hiệu suất từng Nhân viên</span>
        </div>
        <div class="card-body-custom">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th class="col-id">Mã NV</th>
                            <th class="col-name">Tên Nhân Viên</th>
                            <th class="col-data">DS Tháng</th>
                            <th class="col-data">Mục Tiêu</th> 
                            <th class="col-data">Thực Đạt YTD</th>     
                            <th class="col-data">Số ĐH</th>
                            <th class="col-data">PO Tồn</th>
                            <th class="col-detail"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in summary %}
                        <tr class="detail-row" onclick="window.location.href='/sales_detail/{{ row.EmployeeID }}'">
                            <td class="col-id font-monospace">{{ row.EmployeeID | default('N/A') }}</td>
                            <td class="col-name">{{ row.SalesManName | default('N/A') }}</td>
                            
                            <td class="col-data data-amount">
                                {{ row.CurrentMonthSales | format_tr }}
                            </td>
                            
                            {% set reg_sales = row.RegisteredSales | default(0) | float %}
                            <td class="col-data text-secondary">
                                {{ reg_sales | format_tr }}
                            </td>
                            
                            {% set ytd_sales = row.TotalSalesAmount | default(0) | float %}
                            <td class="col-data progress-cell">
                                {% set completion_percent = (ytd_sales / reg_sales) * 100 if reg_sales > 0 else 0 %}
                                {% set bar_width = [completion_percent, 100] | min %} 
                                {% set bar_color = 'var(--success)' if completion_percent >= 100 else 'var(--primary)' %}
                                
                                <div class="progress-wrapper">
                                    <div class="progress-bar-fill" style="width: {{ bar_width }}%; background-color: {{ bar_color }};"></div>
                                    <span class="progress-text {{ 'text-white-shadow' if bar_width > 50 else '' }}">
                                        {{ ytd_sales | format_tr }}
                                    </span>
                                </div>
                            </td>
                            
                            <td class="col-data text-secondary">{{ row.TotalOrders | format_number }}</td>
                            
                            <td class="col-data pending-amount">
                                {{ row.PendingOrdersAmount | format_tr }}
                            </td>
                            <td class="col-detail"><i class="fas fa-chevron-right text-muted"></i></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {% endblock %}