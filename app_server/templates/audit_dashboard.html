{% extends "base.html" %}
{% block title %}Nh·∫≠t k√Ω H·ªá th·ªëng | Titan OS{% endblock %}

{% block extra_css %}
<style>
    .audit-header {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-radius: 1rem; padding: 1.5rem; color: white;
    }
    .table-audit { font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85rem; }
    .table-audit tbody tr { border-bottom: 1px solid #f1f5f9; }
    .table-audit tbody tr:hover { background-color: #f8fafc; }
    
    /* L√†m m·ªù log r√°c, l√†m r·ª±c log quan tr·ªçng */
    .row-INFO { color: #64748b; } 
    .row-WARNING { background-color: #fffbeb !important; color: #b45309; font-weight: 500; }
    .row-CRITICAL { background-color: #fef2f2 !important; color: #b91c1c; font-weight: bold; border-left: 4px solid #ef4444;}
    
    .badge-severity { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;}
    .badge-INFO { background: #e2e8f0; color: #475569; }
    .badge-WARNING { background: #fde68a; color: #d97706; }
    .badge-CRITICAL { background: #fca5a5; color: #991b1b; }

    .details-cell { max-width: 450px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="audit-header mb-4 d-flex justify-content-between align-items-center shadow-sm">
        <div>
            <h4 class="fw-bold mb-1"><i class="fas fa-search-location me-2 text-warning"></i>TRUNG T√ÇM TRA C·ª®U NH·∫¨T K√ù (AUDIT LOGS)</h4>
            <p class="mb-0 text-white-50 small">C√¥ng c·ª• r√† so√°t an ninh v√† truy v·∫øt d·ªØ li·ªáu to√†n h·ªá th·ªëng.</p>
        </div>
        <div class="d-flex gap-2 bg-white p-2 rounded-3 shadow-sm">
            <input type="date" id="dateFrom" class="form-control form-control-sm border-0 bg-light" title="T·ª´ ng√†y">
            <span class="text-dark align-self-center fw-bold">-</span>
            <input type="date" id="dateTo" class="form-control form-control-sm border-0 bg-light" title="ƒê·∫øn ng√†y">
            <button class="btn btn-primary btn-sm fw-bold px-3" onclick="fetchLogs()"><i class="fas fa-filter me-1"></i> L·ªçc</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold text-dark mb-0">Danh s√°ch S·ª± ki·ªán (T·ªëi ƒëa 500 d√≤ng)</h6>
            <div class="d-flex gap-2">
                <select id="filterSeverity" class="form-select form-select-sm border-secondary fw-bold" onchange="fetchLogs()">
                    <option value="">üéØ T·∫•t c·∫£ M·ª©c ƒë·ªô</option>
                    <option value="CRITICAL">üî¥ C·∫£nh b√°o ƒê·ªè (X√≥a, S·ª≠a ti·ªÅn, Quy·ªÅn)</option>
                    <option value="WARNING">üü† C·∫£nh b√°o V√†ng (L·ªói, Sai Pass)</option>
                    <option value="INFO">‚ö™ Th√¥ng tin (Tra c·ª©u, ƒêƒÉng nh·∫≠p)</option>
                </select>
                <input type="text" id="filterUser" class="form-control form-select-sm border-secondary" placeholder="üîç M√£ NV ho·∫∑c T·ª´ kh√≥a..." onkeyup="if(event.keyCode===13) fetchLogs()">
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                <table class="table table-audit mb-0 align-middle table-hover">
                    <thead class="bg-light text-muted text-uppercase sticky-top" style="font-size: 0.75rem; z-index: 1;">
                        <tr>
                            <th class="ps-4">Th·ªùi gian</th>
                            <th>M·ª©c ƒë·ªô</th>
                            <th>Thao t√°c (Action)</th>
                            <th>Ng∆∞·ªùi d√πng</th>
                            <th style="max-width: 450px;">Chi ti·∫øt Payload (Nh·∫•p ƒë·ªÉ xem)</th>
                            <th>IP Client</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody">
                        <tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i> ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="jsonModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-dark text-white rounded-top-4">
                <h6 class="modal-title font-monospace"><i class="fas fa-laptop-code me-2"></i> Truy v·∫øt D·ªØ li·ªáu (Payload)</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-0">
                <pre class="m-0 p-4" style="max-height: 50vh; overflow-y: auto;"><code id="jsonContent" class="language-json text-dark" style="font-size: 0.85rem;"></code></pre>
            </div>
        </div>
    </div>
</div>

<script>
    // Set m·∫∑c ƒë·ªãnh ng√†y hi·ªÉn th·ªã: T·ª´ 3 ng√†y tr∆∞·ªõc ƒë·∫øn H√¥m nay
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const threeDaysAgo = new Date();
        threeDaysAgo.setDate(today.getDate() - 3);
        
        document.getElementById('dateTo').valueAsDate = today;
        document.getElementById('dateFrom').valueAsDate = threeDaysAgo;
        
        fetchLogs(); // T·∫£i l·∫ßn ƒë·∫ßu (Kh√¥ng c√≥ setInterval auto-refresh n·ªØa)
    });

    function fetchLogs() {
        const severity = document.getElementById('filterSeverity').value;
        const user = document.getElementById('filterUser').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        // Hi·ªÉn th·ªã loading
        document.getElementById('logTableBody').innerHTML = '<tr><td colspan="6" class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i></td></tr>';
        
        fetch(`/api/admin/logs/stream?severity=${severity}&user=${user}&date_from=${dateFrom}&date_to=${dateTo}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('logTableBody');
                tbody.innerHTML = '';
                
                if(data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">Kh√¥ng c√≥ b·∫£n ghi n√†o trong kho·∫£ng th·ªùi gian n√†y.</td></tr>';
                    return;
                }

                data.forEach(log => {
                    let icon = 'fas fa-info-circle';
                    if(log.ActionType.includes('LOGIN')) icon = 'fas fa-sign-in-alt';
                    else if(log.ActionType.includes('AUTO_')) icon = 'fas fa-robot text-primary';
                    else if(log.Severity === 'CRITICAL') icon = 'fas fa-fire';
                    else if(log.Severity === 'WARNING') icon = 'fas fa-exclamation-triangle';

                    let displayDetails = log.Details || '';
                    let fullDetailsRaw = (log.Details || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                    
                    if(displayDetails.includes('Data: {')) {
                        displayDetails = displayDetails.split('Data: {')[0] + ' <span class="badge bg-secondary ms-1">{JSON}</span>';
                    }

                    const tr = document.createElement('tr');
                    tr.className = `row-${log.Severity}`;
                    tr.innerHTML = `
                        <td class="ps-4 text-nowrap">${log.CreatedAt}</td>
                        <td><span class="badge-severity badge-${log.Severity}">${log.Severity}</span></td>
                        <td class="fw-bold"><i class="${icon} me-2"></i>${log.ActionType}</td>
                        <td><span class="badge bg-white text-dark border"><i class="fas fa-user-circle me-1 text-secondary"></i> ${log.UserCode}</span></td>
                        <td class="details-cell" onclick="showFullData('${fullDetailsRaw}')" title="Nh·∫•p ƒë·ªÉ xem chi ti·∫øt">${displayDetails}</td>
                        <td class="text-muted small">${log.IPAddress}</td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(err => {
                document.getElementById('logTableBody').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-danger">L·ªói t·∫£i d·ªØ li·ªáu: ${err}</td></tr>`;
            });
    }

    function showFullData(rawData) {
        let displayHtml = rawData;
        if(rawData.includes('Data: {')) {
            let parts = rawData.split('Data: {');
            let jsonPart = '{' + parts[1];
            try {
                let jsonObj = JSON.parse(jsonPart);
                displayHtml = `<div class="text-primary fw-bold mb-3 border-bottom pb-2">${parts[0]}</div>` + JSON.stringify(jsonObj, null, 4);
            } catch(e) {
                displayHtml = rawData; 
            }
        }
        document.getElementById('jsonContent').innerHTML = displayHtml;
        new bootstrap.Modal(document.getElementById('jsonModal')).show();
    }
</script>
{% endblock %}