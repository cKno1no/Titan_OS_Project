{% extends "base.html" %}

{% block title %}N√¢ng T·∫ßm Tri Th·ª©c | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* 1. BACKGROUND M·ªú ·∫¢O NG·∫™U NHI√äN */
    body {
        /* L·∫•y ·∫£nh ng·∫´u nhi√™n ch·ªß ƒë·ªÅ V≈© tr·ª•/Thi√™n nhi√™n m·ªù ·∫£o t·ª´ Unsplash */
        background: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1920&auto=format&fit=crop') no-repeat center center fixed !important;
        background-size: cover !important;
        position: relative;
    }
    
    /* L·ªõp ph·ªß k√≠nh m·ªù (Backdrop Filter) */
    body::before {
        content: '';
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(15, 17, 21, 0.7); /* L·ªõp ph·ªß t·ªëi */
        backdrop-filter: blur(15px); /* Hi·ªáu ·ª©ng k√≠nh m·ªù */
        z-index: -1;
    }

    /* Card trong su·ªët nh·∫π ƒë·ªÉ h√≤a quy·ªán v·ªõi background */
    .card {
        background: rgba(28, 31, 38, 0.8) !important;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 24px;
    }

    .floating-anim { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    
    .timer-badge {
        font-family: 'JetBrains Mono', monospace;
        letter-spacing: 1px;
        transition: all 0.3s ease;
    }
    .timer-danger {
        color: #ff4444 !important;
        animation: blink 1s infinite;
    }
    @keyframes blink { 50% { opacity: 0.5; } }
    
    .alert-custom { border-radius: 12px; box-shadow: var(--shadow-sm); }
</style>
{% endblock %}

{% block content %}
<div class="container py-5" x-data="dailyGame()" x-init="init()">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            
            <div class="text-center mb-5">
                <h1 class="fw-black text-primary display-4 mb-2">
                    <i class="fas fa-brain text-warning me-2"></i>N√ÇNG T·∫¶M TRI TH·ª®C
                </h1>
                <p class="text-muted lead">C·∫≠p nh·∫≠t b·∫£n th√¢n - L√†m ch·ªß c√¥ng ngh·ªá</p>
            </div>

            <div class="alert alert-warning border-0 shadow-sm mb-4 small">
                <div class="d-flex">
                    <i class="fas fa-user-shield me-2 mt-1"></i>
                    <div>
                        <strong>L·ªùi nh·∫Øn t·ª´ Titan:</strong> B·∫°n h√£y ∆∞u ti√™n s·ª≠ d·ª•ng ki·∫øn th·ª©c v√† kinh nghi·ªám c·ªßa b·∫£n th√¢n nh√©. 
                        H·ªá th·ªëng <b>kh√¥ng khuy·∫øn kh√≠ch</b> sao ch√©p t·ª´ AI (GPT/Google) ƒë·ªÉ ch√∫ng ta c√πng x√¢y d·ª±ng gi√° tr·ªã th·∫≠t.
                    </div>
                </div>
            </div>

            <div x-show="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">ƒêang k·∫øt n·ªëi trung t√¢m tri th·ª©c...</p>
            </div>

            <div x-show="!loading && status === 'WAITING'" class="card shadow-lg text-center p-5 animate__animated animate__fadeIn">
                <div class="mb-4">
                    <img src="https://cdn3d.iconscout.com/3d/premium/thumb/clock-5206700-4352236.png" width="150" class="floating-anim">
                </div>
                <h3 class="fw-bold text-white">Ch∆∞a ƒë·∫øn gi·ªù c·∫≠p nh·∫≠t tri th·ª©c!</h3>
                <p class="text-white-50 mb-4">
                    Th·ª≠ th√°ch ti·∫øp theo s·∫Ω m·ªü v√†o: <strong class="text-primary fs-5" x-text="nextSlot"></strong>
                </p>
                <div class="mt-4">
                    <a href="/" class="btn btn-outline-light rounded-pill px-4">V·ªÅ trang ch·ªß</a>
                </div>
            </div>

            <div x-show="!loading && status === 'AVAILABLE'" class="card shadow-lg overflow-hidden animate__animated animate__fadeInUp">
                <div class="card-header bg-primary text-white p-4 d-flex justify-content-between align-items-center">
                    <span class="badge bg-white text-primary fw-bold px-3 py-2"> ƒêANG DI·ªÑN RA</span>
                    <div class="h4 m-0 fw-bold timer-badge" :class="secondsLeft < 60 ? 'timer-danger' : 'text-white'">
                        <i class="fas fa-clock me-2"></i><span x-text="formatTime(secondsLeft)">15:00</span>
                    </div>
                </div>
                <div class="card-body p-4 text-white">
                    <div class="alert alert-custom border-start border-4 border-primary bg-light fs-5 fw-bold text-dark mb-4 shadow-sm">
                        <i class="fas fa-question-circle me-2 text-primary"></i>
                        <span x-text="question"></span>
                    </div>
                    
                    <div class="options-list mb-4" x-show="options && (options.A || options.B || options.C || options.D)">
                        <p class="text-white-50 small fw-bold mb-2 text-uppercase"><i class="fas fa-list-ul me-2"></i>D·ªØ li·ªáu g·ª£i √Ω / C√¢u h·ªèi ph·ª•:</p>
                        <div class="d-flex flex-column gap-2">
                            <template x-for="(val, key) in options" :key="key">
                                <template x-if="val">
                                    <div class="p-3 rounded-3 border bg-dark bg-opacity-50 d-flex align-items-start">
                                        <b class="text-primary me-2" x-text="key + '.'"></b> <span x-text="val"></span>
                                    </div>
                                </template>
                            </template>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold text-primary">B√†i l√†m c·ªßa b·∫°n:</label>
                        <textarea class="form-control form-control-lg border-0 shadow-sm" rows="6" 
                                x-model="answer" placeholder="D·ª±a v√†o c√°c g·ª£i √Ω tr√™n, b·∫°n h√£y nh·∫≠p c√¢u tr·∫£ l·ªùi chi ti·∫øt t·∫°i ƒë√¢y..."></textarea>
                    </div>
                    
                    <button @click="submit()" class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow" 
                            :disabled="submitting || answer.trim().length < 10">
                        <span x-show="!submitting">N·ªôp B√†i <i class="fas fa-paper-plane ms-2"></i></span>
                        <span x-show="submitting"><i class="fas fa-spinner fa-spin me-2"></i>ƒêang g·ª≠i...</span>
                    </button>
                </div>
            </div>

            <div x-show="!loading && status === 'SUBMITTED'" class="card shadow-lg text-center p-5 animate__animated animate__zoomIn">
                <div class="mb-4">
                    <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_9n6mxtis.json" 
                                   background="transparent" speed="1" style="width: 200px; height: 200px; margin: auto;" loop autoplay></lottie-player>
                </div>
                <h3 class="fw-bold text-primary">B√†i l√†m ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!</h3>
                <div class="alert alert-info border-0 shadow-sm mt-3 text-start small">
                    <i class="fas fa-info-circle me-2"></i>
                    AI s·∫Ω ch·∫•m ƒëi·ªÉm v√† g·ª≠i th√¥ng b√°o k·∫øt qu·∫£ v√†o h√≤m th∆∞ sau khi <b>k·∫øt th√∫c 15 ph√∫t l√†m b√†i</b>. B·∫°n h√£y ngh·ªâ ng∆°i nh√©!
                </div>
                <div class="mt-4">
                    <a href="/" class="btn btn-primary rounded-pill px-5">Quay l·∫°i Dashboard</a>
                </div>
            </div>

            <div x-show="!loading && status === 'DONE'" class="card shadow-lg text-center p-5 animate__animated animate__zoomIn">
                <div class="mb-3 display-1">üéâ</div>
                <h2 class="fw-bold text-success">ƒê√£ ho√†n th√†nh phi√™n n√†y!</h2>
                <p class="text-white-50">K·∫øt qu·∫£ ghi nh·∫≠n: <strong class="fs-4 text-primary" x-text="score"></strong>/10</p>
                <div class="p-3 bg-dark bg-opacity-50 rounded-3 mb-4 text-white-50 small italic" x-text="feedback"></div>
                <a href="/" class="btn btn-primary rounded-pill px-5">V·ªÅ trang ch·ªß</a>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function dailyGame() {
        return {
            loading: true,
            status: 'WAITING',
            nextSlot: '',
            question: '',
            options: { A: '', B: '', C: '', D: '' },
            sessionId: null,
            secondsLeft: 900,
            answer: '',
            submitting: false,
            score: 0,
            feedback: '',
            timer: null,

            init() { this.checkStatus(); },

            checkStatus() {
                this.loading = true;
                fetch('/api/challenge/status').then(r => r.json()).then(data => {
                    this.status = data.status;
                    if (data.status === 'AVAILABLE') {
                        this.question = data.question;
                        this.options = data.options || { A: '', B: '', C: '', D: '' };
                        this.sessionId = data.session_id;
                        this.secondsLeft = data.seconds_left || 900;
                        this.startTimer();
                    } else if (data.status === 'WAITING') {
                        this.nextSlot = data.next_slot;
                    } else if (data.status === 'DONE') {
                        this.score = data.score;
                        this.feedback = data.feedback;
                    }
                    this.loading = false;
                }).catch(err => {
                    this.status = 'WAITING';
                    this.nextSlot = 'L·ªói k·∫øt n·ªëi';
                    this.loading = false;
                });
            },

            startTimer() {
                if (this.timer) clearInterval(this.timer);
                this.timer = setInterval(() => {
                    if (this.secondsLeft <= 0) {
                        clearInterval(this.timer);
                        this.status = 'WAITING';
                        Swal.fire({ title: 'H·∫øt gi·ªù!', text: 'Th·ªùi gian c·∫≠p nh·∫≠t tri th·ª©c ƒë√£ k·∫øt th√∫c.', icon: 'error' }).then(() => window.location.reload());
                        return;
                    }
                    this.secondsLeft--;
                }, 1000);
            },

            async submit() {
                if (!this.answer.trim()) return;
                this.submitting = true;
                try {
                    const res = await fetch('/api/challenge/submit', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ session_id: this.sessionId, answer: this.answer })
                    });
                    const data = await res.json();
                    if (data.success) {
                        this.status = 'SUBMITTED';
                        if (this.timer) clearInterval(this.timer);
                        Swal.fire('Th√†nh c√¥ng!', data.msg, 'success');
                    } else {
                        Swal.fire('Th√¥ng b√°o', data.msg, 'warning');
                    }
                } catch (e) {
                    Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i b√†i. Vui l√≤ng ki·ªÉm tra m·∫°ng.', 'error');
                } finally {
                    this.submitting = false;
                }
            },

            formatTime(s) {
                if (s < 0) return "00:00";
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }
        }
    }
</script>
{% endblock %}