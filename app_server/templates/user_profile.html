{% extends "base.html" %}

{% block title %}H·ªì s∆° & G√≥c Flex | Titan OS{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">

<style>
    /* ========================================= */
    /* 1. FLEX STAGE (S√ÇN KH·∫§U T∆Ø∆†NG T√ÅC) */
    /* ========================================= */
    .flex-stage-wrapper {
        position: relative;
        width: 100%;
        height: 75vh;
        min-height: 550px;
        background: radial-gradient(circle at center bottom, #2b3040 0%, #1a1c29 100%);
        border-radius: 0 0 50px 50px;
        overflow: hidden; 
        margin-bottom: -80px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    /* Background ƒë·ªông */
    .stage-bg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-image: var(--bg-image);
        background-size: cover; background-position: center;
        opacity: 0.4; filter: blur(8px); z-index: 0; pointer-events: none;
        animation: bgBreath 10s infinite alternate;
    }
    @keyframes bgBreath {
        0% { transform: scale(1); }
        100% { transform: scale(1.05); }
    }

    .draggable-item {
        position: absolute; cursor: grab; z-index: 10; 
        top: 50%; left: 50%; transform: translate(-50%, -50%); 
        user-select: none;
        transition: transform 0.1s;
    }
    .draggable-item:active { cursor: grabbing; transform: translate(-50%, -50%) scale(0.95); }

    .floating-anim { animation: float 6s ease-in-out infinite; }
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-15px); }
        100% { transform: translateY(0px); }
    }

    /* AVATAR & PET COMPONENT */
    .avatar-wrapper { width: 200px; height: 200px; position: relative; }
    
    .main-avatar {
        width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
        border: 4px solid rgba(255,255,255,0.9); 
        box-shadow: 0 0 50px rgba(67, 24, 255, 0.5);
        background: #fff; position: relative; z-index: 2;
    }
    
    .frame-lottie {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1.7);
        width: 100%; height: 100%; z-index: 3; pointer-events: none;
        filter: drop-shadow(0 0 10px rgba(255,215,0,0.5));
    }
    
    /* [M·ªöI] N√∫t Camera tr√™n Avatar */
    .camera-btn-overlay {
        position: absolute; bottom: 10px; right: 10px;
        width: 45px; height: 45px; border-radius: 50%;
        background: var(--primary); color: white;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        cursor: pointer; z-index: 25; border: 3px solid #fff;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .camera-btn-overlay:hover { transform: scale(1.15) rotate(15deg); background: #fff; color: var(--primary); }

    .stage-info {
        position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%);
        text-align: center; width: 400px; pointer-events: none;
    }
    
    .stage-name { 
        font-family: 'Outfit', sans-serif; font-size: 2.5rem; font-weight: 900; color: white;
        text-shadow: 0 4px 15px rgba(0,0,0,0.8); 
        background: rgba(0,0,0,0.4);
        padding: 5px 25px; border-radius: 30px; 
        backdrop-filter: blur(8px); display: inline-block;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .stage-title {
        background: linear-gradient(45deg, #FFD700, #FFA500, #FF4500); 
        background-size: 200% 200%;
        animation: gradientFlow 3s ease infinite;
        color: #fff;
        padding: 5px 20px; border-radius: 20px; font-weight: 800; font-size: 0.9rem;
        text-transform: uppercase; box-shadow: 0 5px 20px rgba(255, 165, 0, 0.4);
        position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 5;
    }

    .pet-wrapper { width: 280px; height: 280px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); }
    
    .chat-bubble {
        position: absolute; top: -30px; right: 0px; 
        background: rgba(255, 255, 255, 0.95); color: #333;
        padding: 10px 20px; border-radius: 20px 20px 0 20px; 
        font-weight: 800; font-size: 0.9rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        opacity: 0; transition: all 0.4s; pointer-events: none; width: max-content; transform: scale(0.8);
    }
    .pet-wrapper:hover .chat-bubble { opacity: 1; top: -50px; transform: scale(1); }

    /* N√∫t Flex */
    .btn-flex-action {
        position: absolute; top: 20px; right: 20px; z-index: 20;
        background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2); color: white;
        padding: 10px 20px; border-radius: 30px; font-weight: 700;
        transition: all 0.3s;
    }
    .btn-flex-action:hover { background: white; color: var(--primary); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(255,255,255,0.3); }

    /* ========================================= */
    /* 2. CARD & LAYOUT */
    /* ========================================= */
    .profile-body { position: relative; z-index: 20; padding-bottom: 50px; }
    
    .glass-card {
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.5);
        border-radius: 24px; box-shadow: 0 15px 40px rgba(0,0,0,0.08); 
        overflow: hidden; height: 100%; transition: transform 0.3s;
    }
    [data-theme="dark"] .glass-card { background: rgba(30, 30, 40, 0.9); border-color: rgba(255,255,255,0.1); }
    
    .text-gradient {
        background: linear-gradient(90deg, var(--primary), #FF00CC);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .xp-bar-container { 
        background: rgba(0,0,0,0.05); height: 16px; border-radius: 10px; 
        margin: 20px 0; overflow: hidden; position: relative; 
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
    }
    .xp-bar-fill { 
        height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        width: 0%; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
        position: relative;
    }
    .xp-bar-fill::after {
        content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        transform: translateX(-100%); animation: shimmer 2s infinite;
    }

    @keyframes shimmer { 100% { transform: translateX(100%); } }
    @keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    /* ========================================= */
    /* 3. ITEM GRID SYSTEM */
    /* ========================================= */
    .category-header {
        font-size: 0.9rem; font-weight: 800; color: var(--secondary);
        text-transform: uppercase; letter-spacing: 1px; margin: 30px 0 15px 0;
        display: flex; align-items: center; opacity: 0.8;
    }
    .category-header::after { content: ''; flex: 1; height: 2px; background: var(--border-color); margin-left: 15px; border-radius: 2px; }

    .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }

    .item-card {
        aspect-ratio: 1/1; background: var(--card-bg);
        border: 2px solid transparent; border-radius: 24px;
        position: relative; cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }
    .item-card:hover { transform: translateY(-10px) scale(1.02); border-color: var(--primary); box-shadow: 0 20px 40px rgba(67, 24, 255, 0.15); }
    .item-card.active { border-color: var(--success); background: linear-gradient(135deg, rgba(5, 205, 153, 0.1), transparent); }
    .item-card.locked { cursor: not-allowed; filter: grayscale(100%); opacity: 0.6; }
    
    .lock-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.05); z-index: 5;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: #555; font-weight: bold; font-size: 1.2rem;
    }
    .equipped-badge {
        position: absolute; top: 12px; right: 12px;
        background: var(--success); color: white; width: 30px; height: 30px; border-radius: 50%;
        font-size: 14px; display: flex; align-items: center; justify-content: center;
        z-index: 10; box-shadow: 0 4px 10px rgba(5, 205, 153, 0.4);
        animation: popIn 0.3s;
    }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

    .item-preview {
        width: 100%; height: 100%; padding: 25px;
        display: flex; align-items: center; justify-content: center;
        z-index: 1; transition: transform 0.3s;
    }
    .item-card:hover .item-preview { transform: scale(1.1); }
    .item-preview img, .item-preview lottie-player { width: 100%; height: 100%; object-fit: contain; }

    .item-meta {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: rgba(255,255,255,0.9); padding: 12px 0;
        text-align: center; font-size: 0.95rem; font-weight: 700; color: var(--text-dark);
        transform: translateY(100%); transition: transform 0.3s; z-index: 11;
        backdrop-filter: blur(5px);
    }
    .item-card:hover .item-meta { transform: translateY(0); }
    
    .price-tag {
        position: absolute; top: 12px; right: 12px;
        background: var(--card-bg); color: var(--text-dark);
        padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 800;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;
        z-index: 10; border: 1px solid var(--border-color);
    }
    .nav-pills .nav-link { 
        border-radius: 15px; font-weight: 700; padding: 12px 30px;
        background: var(--input-bg); color: var(--secondary); margin-right: 15px;
        transition: all 0.3s; border: 1px solid transparent;
    }
    .nav-pills .nav-link:hover { transform: translateY(-2px); }
    .nav-pills .nav-link.active { background: var(--primary); color: #fff; box-shadow: 0 10px 25px rgba(67, 24, 255, 0.3); }

</style>
{% endblock %}

{% block content %}

<div class="flex-stage-wrapper" id="stage-area">
    <div class="stage-bg"></div>
    
    <div class="position-absolute top-0 end-0 p-4 d-flex gap-2" style="z-index: 20;">
        <button class="btn-flex-action" onclick="flexNow()"><i class="fas fa-magic me-2"></i>KHOE NGAY</button>
    </div>

    <div class="position-absolute top-0 start-50 translate-middle-x mt-4 text-white-50 small fw-bold" style="z-index: 5; letter-spacing: 1px; text-transform: uppercase;">
        <i class="fas fa-arrows-alt me-1"></i> K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp g√≥c Flex
    </div>

    <div class="draggable-item" id="drag-avatar" onclick="interactElement(this)">
        <div class="avatar-wrapper floating-anim" style="animation-delay: 0s;">
            
            <input type="file" id="avatar-upload-input" hidden accept="image/*" onchange="uploadAvatar(this)">

            {% if user.AvatarFrame %}
            <div class="frame-lottie">
                <lottie-player src="{{ url_for('static', filename='assets/json/' + user.AvatarFrame + '.json') }}" background="transparent" speed="1" loop autoplay></lottie-player>
            </div>
            {% endif %}
            
            <img src="{{ user.AvatarUrl if user.AvatarUrl else url_for('static', filename='img/default_avatar.png') }}" class="main-avatar">
            
            <div class="camera-btn-overlay" onclick="event.stopPropagation(); document.getElementById('avatar-upload-input').click();" title="ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán">
                <i class="fas fa-camera"></i>
            </div>
            
            <div class="stage-info">
                {% if user.Title %}
                <div class="stage-title"><i class="fas fa-crown me-1"></i>{{ user.Title }}</div>
                {% endif %}
                <div class="stage-name">{{ user.Nickname if user.Nickname else (user.SHORTNAME or user.USERNAME) }}</div>
            </div>
        </div>
    </div>

    {% if user.EquippedPet %}
    <div class="draggable-item" id="drag-pet" style="left: 75%; top: 65%;" onclick="interactElement(this)">
        <div class="pet-wrapper floating-anim" style="animation-delay: 1.5s;">
            <div class="chat-bubble">Ch√†o s·∫øp! ü¶ä</div>
            <lottie-player src="{{ url_for('static', filename='assets/json/' + user.EquippedPet + '.json') }}" background="transparent" speed="1" loop autoplay></lottie-player>
        </div>
    </div>
    {% endif %}
</div>

<div class="container profile-body">
    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="glass-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0 text-primary"><i class="fas fa-id-card me-2"></i>H·ªì s∆°</h5>
                    <span class="badge bg-light text-dark border">{{ user.Level }}</span>
                </div>
                
                <div class="text-center mb-4">
                    <h2 class="fw-bold m-0 text-gradient" id="display-name">
                        {{ user.Nickname if user.Nickname else (user.SHORTNAME or user.USERNAME) }}
                    </h2>
                    <div class="text-muted small mt-1 fw-bold text-uppercase">{{ user['CHUC VU'] }}</div>
                    
                    <button class="btn btn-sm btn-light rounded-pill mt-2 px-3 shadow-sm border" onclick="requestRename()" title="ƒê·ªïi Bi·ªát danh">
                        <i class="fas fa-pen me-1"></i> ƒê·ªïi t√™n
                    </button>
                </div>

                <div class="d-flex justify-content-between align-items-end mb-1">
                    <span class="info-label small fw-bold text-secondary">TI·∫æN ƒê·ªò LEVEL {{ user.Level + 1 }}</span>
                    <span class="info-val fw-bold text-primary">{{ user.ProgressPercent }}%</span>
                </div>
                <div class="xp-bar-container"><div class="xp-bar-fill" style="width: {{ user.ProgressPercent }}%"></div></div>
                
                <div class="bg-gradient-primary p-3 rounded-4 mt-4 d-flex align-items-center justify-content-between shadow-sm" style="background: linear-gradient(135deg, #FFF 0%, #F4F7FE 100%); border: 1px solid var(--border-color);">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div>
                            <div class="small text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">Titan Coins</div>
                            <h4 class="mb-0 fw-bold text-dark">{{ "{:,}".format(user.TotalCoins) }}</h4>
                        </div>
                    </div>
                    <button class="btn btn-light btn-sm rounded-circle border" data-bs-toggle="modal" data-bs-target="#changePassModal" title="ƒê·ªïi m·∫≠t kh·∫©u"><i class="fas fa-key text-secondary"></i></button>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="glass-card p-4">
                <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-inventory"><i class="fas fa-backpack me-2"></i>T√∫i ƒë·ªì c·ªßa t√¥i</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-shop"><i class="fas fa-shopping-cart me-2"></i>C·ª≠a h√†ng V·∫≠t ph·∫©m</button></li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-inventory">
                        {% if inventory %}
                            <div class="category-header"><i class="fas fa-paw me-2 text-warning"></i>Th√∫ c∆∞ng (Pets)</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType.strip().upper() == 'PET' %}
                                    <div class="item-card {{ 'active' if item.ItemCode == user.EquippedPet }}" onclick="equipItem('{{ item.ItemCode }}', 'PET')">
                                        {% if item.ItemCode == user.EquippedPet %}<div class="equipped-badge"><i class="fas fa-check"></i></div>{% endif %}
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode|capitalize }}</div>
                                    </div>
                                {% else %}<div class="text-muted small fst-italic">B·∫°n ch∆∞a c√≥ th√∫ c∆∞ng n√†o.</div>{% endfor %}
                            </div>

                            <div class="category-header mt-4"><i class="fas fa-crop-alt me-2 text-info"></i>Khung (Frames)</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType == 'FRAME' or 'frame' in item.ItemCode %}
                                    <div class="item-card {{ 'active' if item.ItemCode == user.AvatarFrame }}" onclick="equipItem('{{ item.ItemCode }}', 'FRAME')">
                                        {% if item.ItemCode == user.AvatarFrame %}<div class="equipped-badge"><i class="fas fa-check"></i></div>{% endif %}
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode }}</div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="category-header mt-4"><i class="fas fa-palette me-2 text-danger"></i>Giao di·ªán (Themes)</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType == 'THEME' or item.ItemCode in ['light', 'dark', 'fantasy', 'adorable'] %}
                                    <div class="item-card {{ 'active' if item.ItemCode == user.ThemeColor }}" onclick="equipItem('{{ item.ItemCode }}', 'THEME')">
                                        {% if item.ItemCode == user.ThemeColor %}<div class="equipped-badge"><i class="fas fa-check"></i></div>{% endif %}
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode|capitalize }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="category-header mt-4"><i class="fas fa-bolt me-2 text-warning"></i>K·ªπ nƒÉng (Skills)</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType.strip().upper() == 'SKILL' %}
                                    <div class="item-card" onclick="equipItem('{{ item.ItemCode }}', 'SKILL')">
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemName }}</div>
                                    </div>
                                {% else %}<div class="text-muted small fst-italic">B·∫°n ch∆∞a s·ªü h·ªØu k·ªπ nƒÉng n√†o.</div>{% endfor %}
                            </div>

                            <div class="category-header mt-4"><i class="fas fa-magic me-2 text-primary"></i>V·∫≠t ph·∫©m (D√πng 1 l·∫ßn)</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType == 'CONSUMABLE' %}
                                    <div class="item-card" id="inventory-item-{{ item.ItemCode }}" onclick="useConsumable('{{ item.ItemCode }}', '{{ item.ItemName }}')">
                                        <div class="item-preview">
                                            {% if item.ItemCode == 'rename_card' %}
                                                <i class="fas fa-id-card fa-3x text-info"></i>
                                            {% else %}
                                                <i class="fas fa-box fa-3x text-muted"></i>
                                            {% endif %}
                                        </div>
                                        <div class="item-meta">{{ item.ItemName }}</div>
                                    </div>
                                {% endfor %}
                            </div>

                        {% else %}
                            <div class="text-center py-5">
                                <lottie-player src="https://assets9.lottiefiles.com/packages/lf20_s0lq5g9o.json" background="transparent" speed="1" style="width: 200px; height: 200px; margin: auto;" loop autoplay></lottie-player>
                                <p class="text-muted mt-3">T√∫i ƒë·ªì tr·ªëng tr∆°n. H√£y gh√© C·ª≠a h√†ng nh√©!</p>
                            </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-shop">
                        
                        <div class="category-header"><i class="fas fa-paw me-2 text-warning"></i>Th√∫ c∆∞ng</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'PET' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    
                                    {% if is_locked %}
                                        <div class="lock-overlay"><i class="fas fa-lock mb-2 fa-2x text-muted"></i><span class="badge bg-dark">Lv.{{ item.MinLevel }}</span></div>
                                    {% else %}
                                        <div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>
                                    {% endif %}
                                    
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="category-header mt-4"><i class="fas fa-crop-alt me-2 text-info"></i>Khung Avatar</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'FRAME' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2 fa-2x text-muted"></i><span class="badge bg-dark">Lv.{{ item.MinLevel }}</span></div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="category-header mt-4"><i class="fas fa-palette me-2 text-danger"></i>Giao di·ªán (Themes)</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'THEME' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2 fa-2x text-muted"></i><span class="badge bg-dark">Lv.{{ item.MinLevel }}</span></div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="category-header mt-4"><i class="fas fa-bolt me-2 text-warning"></i>K·ªπ nƒÉng (Skills)</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'SKILL' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2 fa-2x text-muted"></i><span class="badge bg-dark">Lv.{{ item.MinLevel }}</span></div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="category-header mt-4"><i class="fas fa-magic me-2 text-primary"></i>V·∫≠t ph·∫©m h·ªó tr·ª£</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'CONSUMABLE' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2"></i> Lv.{{ item.MinLevel }}</div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        {% if item.ItemCode == 'rename_card' %}
                                            <i class="fas fa-id-card fa-3x text-info"></i>
                                        {% else %}
                                            <i class="fas fa-box fa-3x text-muted"></i>
                                        {% endif %}
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="changePassModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light"><h5 class="modal-title fw-bold">ƒê·ªïi m·∫≠t kh·∫©u</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="password" id="old-pass" class="form-control mb-3 p-3" placeholder="M·∫≠t kh·∫©u c≈©">
                <input type="password" id="new-pass" class="form-control p-3" placeholder="M·∫≠t kh·∫©u m·ªõi">
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-100 py-2 fw-bold" onclick="changePassword()">X√°c nh·∫≠n ƒë·ªïi</button></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    // --- DRAG LOGIC ---
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;
        function dragMouseDown(e) { e = e || window.event; pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
        function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }
    document.addEventListener('DOMContentLoaded', function() {
        dragElement(document.getElementById("drag-avatar"));
        const pet = document.getElementById("drag-pet");
        if(pet) dragElement(pet);
    });

    // --- INTERACTION LOGIC ---
    function interactElement(el) {
        el.classList.add('interact-anim'); setTimeout(() => el.classList.remove('interact-anim'), 500);
        if(el.id === 'drag-pet') {
            const msgs = ["Ch√†o s·∫øp!", "C·ªë l√™n!", "Titan OS x·ªãn!", "ƒê√≥i qu√°...", "L√†m vi·ªác n√†o!", "Y√™u s·∫øp! ‚ù§Ô∏è"];
            const bubble = el.querySelector('.chat-bubble');
            if(bubble) { 
                bubble.innerText = msgs[Math.floor(Math.random()*msgs.length)]; 
                bubble.style.opacity=1; 
                bubble.style.top = "-50px";
                setTimeout(()=>{ bubble.style.opacity=0; bubble.style.top = "-30px"; }, 3000); 
            }
        }
    }

    // --- CONFETTI EFFECT ---
    function fireConfetti() {
        var count = 200;
        var defaults = { origin: { y: 0.7 } };
        function fire(particleRatio, opts) {
            confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * particleRatio) }));
        }
        fire(0.25, { spread: 26, startVelocity: 55, });
        fire(0.2, { spread: 60, });
        fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
        fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
        fire(0.1, { spread: 120, startVelocity: 45, });
    }

    function flexNow() {
        fireConfetti();
    }

    // --- GAME LOGIC ---
    function alertLocked(level) { alert(`üîí V·∫≠t ph·∫©m n√†y y√™u c·∫ßu Level ${level} ƒë·ªÉ m·ªü kh√≥a! H√£y c√†y th√™m XP nh√©!`); }

    function uploadAvatar(input) {
        if (input.files && input.files[0]) {
            const formData = new FormData(); formData.append('avatar', input.files[0]);
            fetch('/api/user/upload_avatar', {method: 'POST', body: formData}).then(r=>r.json()).then(data=>{
                if(data.success) { location.reload(); } else alert(data.message);
            });
        }
    }

    function buyItem(itemCode, price) {
        if(!confirm(`Mua v·∫≠t ph·∫©m n√†y v·ªõi gi√° ${price} Coins?`)) return;
        fetch('/api/user/buy_item', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ item_code: itemCode })})
        .then(r=>r.json()).then(res=>{ 
            if(res.success) {
                fireConfetti();
                setTimeout(() => location.reload(), 1500);
            } else {
                alert(res.message);
            }
        });
    }

    function equipItem(itemCode, type) {
        fetch('/api/user/equip_item', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ item_code: itemCode })})
        .then(r=>r.json()).then(res=>{ 
            if(res.success) {
                if(['light','dark','fantasy','adorable'].includes(itemCode)) {
                    document.documentElement.setAttribute('data-theme', itemCode);
                    localStorage.setItem('titan_theme', itemCode);
                }
                fireConfetti();
                setTimeout(() => location.reload(), 1000);
            } else alert(res.message);
        });
    }
    
    function changePassword() {
        const o = document.getElementById('old-pass').value; const n = document.getElementById('new-pass').value;
        if(!o||!n) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin");
        fetch('/api/user/change_password', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({old_pass: o, new_pass: n})})
        .then(r=>r.json()).then(res=>{ alert(res.message); if(res.success) location.reload(); });
    }

    // Logic ki·ªÉm tra th·∫ª ƒë·ªïi t√™n
    {% set has_card = false %}
    {% for item in inventory %}
        {% if item.ItemCode == 'rename_card' %}
            {% set has_card = true %}
        {% endif %}
    {% endfor %}

    function requestRename() {
        const hasCard = {{ 'true' if has_card else 'false' }};
        if(!hasCard) {
            if(confirm("B·∫°n c·∫ßn 'Th·∫ª ƒê·ªïi T√™n'. ƒê·∫øn Shop mua ngay?")) {
                var triggerEl = document.querySelector('button[data-bs-target="#tab-shop"]');
                var tabInstance = bootstrap.Tab.getInstance(triggerEl) || new bootstrap.Tab(triggerEl);
                tabInstance.show();
            }
            return;
        }

        let currentName = document.getElementById('display-name').innerText.trim();
        let newName = prompt("Nh·∫≠p bi·ªát danh m·ªõi (T·ªëi ƒëa 20 k√Ω t·ª±):", currentName);

        if (newName !== null) {
            newName = newName.trim();
            if (newName === "" || newName === currentName) return;
            
            fetch('/api/user/use_rename_card', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nickname: newName })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    fireConfetti();
                    document.getElementById('display-name').innerText = newName;
                    
                    // X√≥a v·∫≠t ph·∫©m UI
                    const cardElement = document.getElementById('inventory-item-rename_card');
                    if (cardElement) cardElement.remove();

                    alert("‚úÖ ƒê·ªïi t√™n th√†nh c√¥ng!");
                    location.reload();
                } else {
                    alert("‚ùå " + res.message);
                }
            });
        }
    }

    function useConsumable(itemCode, itemName) {
        if (itemCode === 'rename_card') {
            requestRename();
        } else {
            alert("V·∫≠t ph·∫©m n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng t·ª± ƒë·ªông khi c·∫ßn thi·∫øt!");
        }
    }
</script>
{% endblock %}