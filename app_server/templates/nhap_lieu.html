{% extends "base.html" %}

{% block title %}Soạn Báo Cáo | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* --- FORM ELEMENTS --- */
    .form-control, .form-select {
        border: 1px solid var(--border-color); background-color: var(--input-bg); border-radius: 12px;
        padding: 10px 15px; font-size: 0.95rem; color: var(--text-dark); box-shadow: none; transition: all 0.2s;
    }
    .form-control:focus, .form-select:focus { 
        background-color: var(--card-bg); box-shadow: 0 0 0 2px var(--primary); border-color: var(--primary);
    }
    .form-control[readonly] { background-color: var(--border-color); opacity: 0.8; }

    /* --- ACCORDION --- */
    .custom-accordion .accordion-item {
        border: 1px solid var(--border-color); background: var(--card-bg); 
        border-radius: 16px !important; box-shadow: var(--shadow-sm); 
        margin-bottom: 20px; overflow: hidden;
    }
    .custom-accordion .accordion-button { 
        background-color: var(--card-bg); color: var(--text-dark); 
        font-weight: 700; font-size: 1.05rem; padding: 15px 20px; 
    }
    .custom-accordion .accordion-button:not(.collapsed) { 
        background-color: var(--input-bg); color: var(--primary); border-bottom: 1px solid var(--border-color);
    }
    .custom-accordion .accordion-body { padding: 20px; background-color: var(--card-bg); }

    /* --- TABS (Pills) --- */
    .nav-pills-custom { 
        background-color: var(--input-bg); padding: 5px; border-radius: 12px; 
        display: inline-flex; margin-bottom: 20px; border: 1px solid var(--border-color);
    }
    .nav-pills-custom .nav-link { 
        color: var(--secondary); font-weight: 600; border-radius: 8px; 
        padding: 8px 20px; transition: all 0.2s; 
    }
    .nav-pills-custom .nav-link.active { 
        background-color: var(--primary); color: white; box-shadow: var(--shadow-sm); 
    }

    /* --- EDITOR --- */
    .rich-editor {
        background: var(--card-bg); min-height: 450px; white-space: pre-wrap; overflow-y: auto;
        border-radius: 16px; font-size: 0.95rem; line-height: 1.6; padding: 20px;
        border: 1px solid var(--border-color); color: var(--text-dark);
    }
    .rich-editor:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); }

    /* --- SIDEBAR & TAGS --- */
    .sticky-sidebar { position: sticky; top: 20px; }
    
    .preview-card, .tag-pool-card {
        background: var(--card-bg); border-radius: 16px; overflow: hidden;
        border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); margin-bottom: 20px;
    }
    .card-header-sidebar { padding: 12px 15px; font-weight: 700; font-size: 0.9rem; color: white; }
    .bg-preview { background-color: var(--success); }
    .bg-pool { background-color: var(--primary); }
    
    .sidebar-body { padding: 15px; max-height: 400px; overflow-y: auto; }

    .tag-btn {
        display: flex; align-items: center; width: 100%; background-color: var(--card-bg);
        border: 1px solid var(--border-color); border-radius: 10px; padding: 10px 12px;
        margin-bottom: 8px; color: var(--secondary); font-weight: 500; font-size: 0.85rem;
        cursor: pointer; transition: all 0.2s;
    }
    .tag-btn:hover { 
        background-color: var(--input-bg); color: var(--primary); 
        border-color: var(--primary); transform: translateX(3px); 
    }
    .tag-btn i { margin-right: 8px; color: var(--primary); }
    .tag-btn.global-tag { background-color: rgba(255, 181, 71, 0.1); border-color: var(--warning); color: #B71C1C; }
    .tag-btn.global-tag i { color: var(--warning); }

    /* --- INJECTED HEADER (Inside Editor) --- */
    .injected-header-p {
        display: flex; justify-content: space-between; align-items: center;
        background: var(--input-bg); border: 1px solid var(--border-color); border-left: 4px solid var(--primary);
        border-radius: 8px; padding: 6px 10px; margin-bottom: 0.5em; font-size: 0.9rem; color: var(--text-dark);
    }
    .delete-header-btn { 
        text-decoration: none; color: var(--danger); font-weight: 700; 
        padding-left: 10px; opacity: 0.6; cursor: pointer;
    }
    .delete-header-btn:hover { opacity: 1; }

    /* Search Dropdown */
    #kh_search_results { 
        position: absolute; width: 100%; z-index: 1050; border: 1px solid var(--border-color); 
        border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 5px; 
        background-color: var(--card-bg); color: var(--text-dark);
    }
    .hidden-field { display: none !important; }
</style>
{% endblock %}

{% block page_title %}Soạn Báo Cáo{% endblock %}
{% block page_sub %}Nhập liệu thông minh (Hybrid v4.5){% endblock %}

{% block header_actions %}
<a href="/" class="btn btn-light border shadow-sm text-decoration-none fw-bold" style="background: var(--card-bg); color: var(--text-dark);">
    <i class="fas fa-times me-2"></i>Đóng
</a>
{% endblock %}

{% block content %}
    <form method="POST" action="/nhaplieu" id="reportForm" enctype="multipart/form-data">
        
        <div class="accordion custom-accordion" id="setupAccordion">
            
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                        <i class="fas fa-user-tag me-3 text-primary"></i> 1. Thông Tin & Khách Hàng
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#setupAccordion">
                    <div class="accordion-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-2">
                                <label class="form-label">ID Bản ghi</label>
                                <input type="text" class="form-control" value="[AUTO]" readonly> 
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Loại Báo cáo <span class="text-danger">*</span></label>
                                <select name="loai" id="ddl_loai_bao_cao" class="form-select" required>
                                    <option value="">-- Chọn Loại --</option>
                                    {% for loai in loai_bao_cao %}
                                    <option value="{{ loai.LOAI }}">{{ loai['DIEN GIAI'] }} ({{ loai.LOAI }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Người báo cáo <span class="text-danger">*</span></label>
                                <select name="nv_bao_cao" class="form-select" required>
                                    {% for user in users %}
                                    <option value="{{ user.USERCODE }}" {% if user.USERCODE == default_usercode %} selected {% endif %}>
                                        {{ user.SHORTNAME }} ({{ user.USERNAME }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ngày Báo cáo <span class="text-danger">*</span></label>
                                <input type="date" name="ngay_bao_cao" class="form-control" value="{{ now_date.strftime('%Y-%m-%d') }}" required>
                            </div>
                        </div>

                        <hr style="border-color: var(--border-color); opacity: 0.5;">

                        <div class="row g-3 align-items-start">
                            <div class="col-md-3">
                                <label class="form-label">Tìm Khách hàng</label>
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-transparent ps-3" style="position: absolute; z-index: 10;"><i class="fas fa-search text-secondary"></i></span>
                                    <input type="text" id="kh_ten_tat" placeholder="Gõ tên..." class="form-control ps-5">
                                </div>
                                <small id="kh_status" class="text-muted mt-1 d-block" style="font-size: 0.8rem;">Nhập tên để tìm...</small>
                            </div>

                            <div class="col-md-5 position-relative">
                                <label class="form-label">Đối tượng được chọn <span class="text-danger">*</span></label> 
                                <input type="text" id="kh_ten_day_du" placeholder="Chưa chọn khách hàng" class="form-control fw-bold" readonly> 
                                <input type="hidden" name="ma_doi_tuong_kh" id="kh_ma_doi_tuong" required>
                                <select id="kh_search_results" class="form-select" size="5" style="display:none;" onchange="chonKhachHang()"></select>
                            </div>

                            <div class="col-md-4">
                                <div class="p-3 rounded-3" style="background: var(--input-bg); border: 1px solid var(--border-color);">
                                    <div class="row">
                                        <div class="col-12 mb-2">
                                            <small class="d-block text-secondary">Địa chỉ:</small>
                                            <span class="fw-bold text-dark small" id="ref_diachi">...</span>
                                        </div>
                                        <div class="col-12">
                                            <small class="d-block text-secondary">Liên hệ:</small>
                                            <span class="fw-bold text-success small" id="ref_nlh_count">...</span> 
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <label class="form-label mb-0">Gặp Nhân sự (1)</label>
                                    <a href="#" onclick="openNhansuForm(event)" class="text-decoration-none small fw-bold text-primary"><i class="fas fa-plus"></i> Tạo mới</a>
                                </div>
                                <select name="nhansu_hengap_1" id="nhansu_hengap_1" class="form-select">
                                    <option value="">-- Chọn Nhân sự --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Gặp Nhân sự (2)</label>
                                <select name="nhansu_hengap_2" id="nhansu_hengap_2" class="form-select">
                                    <option value="">-- Chọn (Không bắt buộc) --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTwo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                        <i class="fas fa-poll-h me-3 text-warning"></i> 2. Phân loại & Kết quả
                    </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#setupAccordion">
                    <div class="accordion-body">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <label class="form-label text-primary" for="select_noi_dung_4">Mục đích gặp *</label>
                                <select name="noi_dung_4" id="select_noi_dung_4" class="form-select" required>
                                    <option value="">-- Vui lòng chọn --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-primary" for="select_noi_dung_5">Kết quả *</label>
                                <select name="noi_dung_5" id="select_noi_dung_5" class="form-select" required>
                                    <option value="">-- Vui lòng chọn --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-primary" for="select_danh_gia_4">Hành động tiếp theo *</label>
                                <select name="danh_gia_4" id="select_danh_gia_4" class="form-select" required>
                                    <option value="">-- Vui lòng chọn --</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <div class="p-3 rounded-4" style="border: 2px dashed var(--border-color); background-color: var(--input-bg);">
                                    <label class="form-label mb-2 text-muted"><i class="fas fa-paperclip me-2"></i>Đính kèm tài liệu (Ảnh, PDF...)</label>
                                    <input type="file" name="attachment_file" class="form-control" multiple>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <h5 class="mb-3 fw-bold text-dark"><i class="fas fa-edit me-2 text-primary"></i>3. Nội dung chi tiết</h5>
            </div>
            
            <div class="col-lg-8">
                <div class="card p-3 shadow-sm border-0" style="background: var(--card-bg);">
                    <ul class="nav nav-pills nav-pills-custom" id="reportTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-a-tab" data-bs-toggle="pill" data-bs-target="#tab-a-pane" type="button"><span id="lbl_tab_A">Tab A</span></button>
                        </li>
                        <li class="nav-item" role="presentation" id="li_tab_b">
                            <button class="nav-link" id="tab-b-tab" data-bs-toggle="pill" data-bs-target="#tab-b-pane" type="button"><span id="lbl_tab_B">Tab B</span></button>
                        </li>
                        <li class="nav-item" role="presentation" id="li_tab_c">
                            <button class="nav-link" id="tab-c-tab" data-bs-toggle="pill" data-bs-target="#tab-c-pane" type="button"><span id="lbl_tab_C">Tab C</span></button>
                        </li>
                    </ul>

                    <div class="tab-content pt-2">
                        <div class="tab-pane fade show active" id="tab-a-pane">
                            <div class="fw-bold mb-2 text-primary"><i class="fas fa-pen"></i> Nội dung chính</div>
                            <div id="editor_noi_dung_1" class="rich-editor" contenteditable="true"></div>
                            <input type="hidden" name="danh_gia_2" id="hidden_danh_gia_2">
                        </div>

                        <div class="tab-pane fade" id="tab-b-pane">
                            <div class="fw-bold mb-2 text-primary"><i class="fas fa-align-left"></i> Nội dung mở rộng</div>
                            <div id="editor_noi_dung_2" class="rich-editor" contenteditable="true"></div>
                            <input type="hidden" name="noi_dung_2" id="hidden_noi_dung_2">
                        </div>

                        <div class="tab-pane fade" id="tab-c-pane">
                            <div class="fw-bold mb-2 text-primary"><i class="fas fa-star"></i> Đánh giá / Kế hoạch</div>
                            <div id="editor_danh_gia_1" class="rich-editor" contenteditable="true"></div>
                            <input type="hidden" name="noi_dung_1" id="hidden_noi_dung_1">
                        </div>
                    </div>

                    <input type="hidden" name="noi_dung_3" value="">
                    <input type="hidden" name="danh_gia_1" value=""> 
                    <input type="hidden" name="danh_gia_3" value="">
                    <input type="hidden" name="danh_gia_5" value="">
                </div>
            </div>

            <div class="col-lg-4">
                <div class="sticky-sidebar">
                    
                    <div class="preview-card">
                        <div class="card-header-sidebar bg-preview">
                            <i class="fas fa-lightbulb me-2"></i> Nội dung Gợi ý
                        </div>
                        <div class="sidebar-body" id="suggestion-preview-content" style="background: var(--card-bg); color: var(--text-dark);">
                            <p class="text-muted small">Hãy chọn một thẻ gợi ý từ bể chờ ở dưới...</p>
                        </div>
                    </div>

                    <div class="tag-pool-card">
                        <div class="card-header-sidebar bg-pool">
                            <i class="fas fa-tags me-2"></i> Thẻ có sẵn
                        </div>
                        <div class="sidebar-body" id="tag-pool-sidebar-body" style="background: var(--card-bg);">
                            <p class="text-muted small text-center mt-4">Vui lòng chọn Loại Báo cáo.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="d-flex justify-content-center gap-3 my-5"> 
            <button type="submit" class="btn btn-success px-5 py-2 fw-bold shadow"><i class="fas fa-save me-2"></i>Lưu Báo Cáo</button>
            <a href="/" class="btn btn-back text-decoration-none d-flex align-items-center"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/nhap_lieu.js') }}"></script>
{% endblock %}