{% extends "base.html" %}

{% block title %}Duyệt Chào Giá (v2) | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* TABLE LAYOUT */
    .table-container { 
        max-height: 80vh; overflow-y: auto; 
        border: 1px solid var(--border-color); border-radius: 12px;
    }
    
    .table-approval th { 
        position: sticky; top: 0; z-index: 10;
        background-color: var(--input-bg) !important; 
        color: var(--secondary) !important;
        font-weight: 700; font-size: 0.85rem; text-transform: uppercase;
        padding: 15px 10px; border-bottom: 2px solid var(--border-color);
        white-space: nowrap; text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .table-approval td { 
        vertical-align: middle; font-size: 0.9rem; 
        border-bottom: 1px solid var(--border-color);
        padding: 12px 10px; color: var(--text-dark);
    }

    /* Status & Logic */
    .quote-row { transition: background-color 0.2s; cursor: pointer; }
    .quote-row:hover td { background-color: var(--input-bg) !important; }
    .quote-row.selected td { background-color: rgba(67, 24, 255, 0.05) !important; color: var(--primary); font-weight: 600; }
    
    .status-border { border-left: 5px solid transparent; }
    .status-pass { border-left-color: var(--success); }
    .status-fail { border-left-color: var(--danger); }
    .status-pending { border-left-color: var(--warning); }
    
    .ratio-alert { color: var(--danger); font-weight: 800; }
    .bg-highlight { animation: highlightFade 2s forwards; }
    @keyframes highlightFade { 0% { background-color: rgba(5, 205, 153, 0.2); } 100% { background-color: transparent; } }

    /* Columns */
    .col-ratio { width: 80px; text-align: right; }
    .col-nvkd { width: 150px; text-align: center; }
    .col-gt { width: 140px; text-align: right; font-weight: 700; }
    .col-result { max-width: 300px; }

    /* Modal Details */
    .table-detail th { background: var(--primary) !important; color: white !important; font-size: 0.8rem; text-align: center; }
    .table-detail td { font-size: 0.9rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    
    /* Loading Overlay */
    .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
    .htmx-request .htmx-indicator { opacity: 1; }
    .htmx-request.htmx-indicator { opacity: 1; }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-certificate me-2 text-primary"></i> PHÊ DUYỆT BÁO GIÁ{% endblock %}
{% block page_sub %}Chào mừng, <strong>{{ current_user.shortname }}</strong> ({{ current_user.usercode }}){% endblock %}

{% block header_actions %}
<a href="/" class="btn btn-back"><i class="fas fa-home me-2"></i>Portal</a>
<a href="{{ url_for('approval_bp.sales_order_approval_dashboard') }}" target="_blank" class="btn btn-success text-white shadow-sm">
    <i class="fas fa-file-invoice-dollar me-2"></i>Duyệt ĐH Bán
</a>
{% endblock %}

{% block content %}
    <div class="main-card mb-4" x-data>
        <div class="card-body-custom" style="padding: 20px;">
            <form hx-post="{{ url_for('approval_bp.quote_approval_dashboard') }}" 
                  hx-target="#table-container" 
                  hx-select="#table-container"
                  hx-swap="outerHTML"
                  class="row g-3 align-items-end">
                
                <div class="col-md-3">
                    <label class="form-label text-secondary small fw-bold">Từ Ngày</label>
                    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-secondary small fw-bold">Đến Ngày</label>
                    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">
                        <i class="fas fa-filter me-2"></i> Lọc
                        <span class="htmx-indicator spinner-border spinner-border-sm ms-2" role="status"></span>
                    </button>
                </div>
                <div class="col-md-4">
                     <div class="input-group">
                        <span class="input-group-text border-0 bg-transparent ps-3" style="position: absolute; z-index: 10;"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" name="search" class="form-control ps-5" placeholder="Tìm Mã BG, Khách hàng..."
                               hx-post="{{ url_for('approval_bp.quote_approval_dashboard') }}"
                               hx-trigger="keyup changed delay:500ms"
                               hx-target="#table-container"
                               hx-select="#table-container"
                               hx-swap="outerHTML"
                               hx-include="[name='date_from'], [name='date_to']">
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="main-card" x-data="quoteApproval()">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <span><i class="fas fa-list-ul me-2 text-primary"></i> DANH SÁCH CẦN DUYỆT</span>
            <span class="badge bg-light text-dark border">{{ quotes|length }} phiếu</span>
        </div>
        
        <div id="table-container" class="card-body-custom p-0">
            <div class="table-container">
                <table class="table table-hover table-approval mb-0"> 
                    <thead>
                        <tr>
                            <th class="col-ratio">Hệ số</th> 
                            <th>Mã BG</th>
                            <th>Ngày</th> 
                            <th class="text-start">Khách hàng</th>
                            <th class="col-nvkd">NVKD</th> 
                            <th class="text-center">TKKD</th> 
                            <th class="col-gt">Tổng GT</th> 
                            <th class="col-result text-start">KẾT QUẢ KIỂM TRA</th>
                            <th class="text-center" style="width: 120px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for quote in quotes %}
                        {% set result = quote.ApprovalResult %}
                        {% set status = result.Passed %}
                        {% set approver_id = result.ApproverRequired %}
                        {% set row_class = 'status-pass' if status else ('status-pending' if 'PENDING' in result.Reason else 'status-fail') %}
                        
                        <tr class="quote-row status-border {{ row_class }}" 
                            :class="{'selected': selectedId === '{{ quote.QuotationID }}', 'bg-highlight': justUpdated === '{{ quote.QuotationID }}'}"
                            @click="loadDetails('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}')">
                            
                            <td class="text-end col-ratio">
                                <span class="fw-bold {% if result.ApprovalRatio < 138 %} ratio-alert {% endif %}">
                                    {{ result.ApprovalRatio }}
                                </span>
                            </td>
                            
                            <td class="fw-bold text-primary">{{ quote.QuotationNo }}</td>
                            <td class="text-center small">{{ quote.QuotationDate | format_date }}</td>
                            
                            <td class="text-start text-truncate" style="max-width: 250px;" title="{{ quote.ClientName }}">
                                {{ quote.ClientName | default('N/A') }}
                            </td>
                            
                            <td class="col-nvkd text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="me-2">{{ quote.NVKDName | default(quote.SalesManID) }}</span>
                                    <button class="btn btn-xs btn-light border shadow-sm p-1" title="Đổi NVKD"
                                            @click.stop="openSalesmanModal('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}', '{{ quote.SalesManID }}')">
                                        <i class="fas fa-pen text-muted" style="font-size: 0.7rem;"></i>
                                    </button>
                                </div>
                            </td>
                            <td class="text-center small text-muted">{{ quote.SalesAdminName | default(quote.EmployeeID) }}</td> 
                            
                            <td class="text-end col-gt text-dark">{{ quote.SaleAmount | format_tr }}</td>
                            
                            <td class="col-result text-start small">
                                {% if result.Passed %}
                                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>{{ result.Reason }}</span>
                                {% else %}
                                    <span class="{{ 'text-warning' if 'PENDING' in result.Reason else 'text-danger' }}">
                                        {{ result.Reason }}
                                    </span>
                                {% endif %}
                            </td>
                            
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-1">
                                    {% if quote.NeedsCostOverride == 1 and not quote.HasCostOverrideData %}
                                        <button class="btn btn-warning btn-sm shadow-sm text-dark px-2 fw-bold" 
                                                @click.stop="openCostModal('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}')">
                                            <i class="fas fa-coins me-1"></i>Cost
                                        </button>
                                    {% elif status and current_user_code in approver_id %}
                                        <button class="btn btn-success btn-sm shadow-sm text-white px-3 fw-bold" 
                                                @click.stop="approve('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}', '{{ quote.ClientID }}', '{{ quote.EmployeeID }}', {{ result.ApprovalRatio }})">
                                            <i class="fas fa-check me-1"></i>Duyệt
                                        </button>
                                    {% else %}
                                        <span class="badge bg-light text-secondary border">Chờ xử lý</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="9" class="text-center text-muted py-5">Không có báo giá nào.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-info-circle me-2 text-primary"></i> Chi tiết: <span x-text="detailNo" class="fw-bold"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div x-show="loading" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Đang tải...</div>
                        <div class="table-responsive" x-show="!loading">
                            <table class="table table-sm table-striped table-bordered mb-0 table-detail">
                                <thead><tr><th>Mã hàng</th><th>Tên hàng</th><th>SL</th><th>Đơn giá</th><th>Giá QĐ</th><th>Thành tiền</th><th>Ghi chú</th></tr></thead>
                                <tbody>
                                    <template x-for="item in details" :key="item.MaHang">
                                        <tr>
                                            <td class="text-center font-monospace" x-text="item.MaHang"></td>
                                            <td x-text="item.TenHang"></td>
                                            <td class="text-end" x-text="formatNum(item.SoLuong)"></td>
                                            <td class="text-end" x-text="formatNum(item.DonGia)"></td>
                                            <td class="text-end fw-bold" :class="checkPrice(item) ? 'text-success' : 'text-danger'" x-text="formatNum(item.DonGiaQuyDinh)"></td>
                                            <td class="text-end fw-bold" x-text="formatNum(item.ThanhTien)"></td>
                                            <td class="small text-muted" x-text="item.Notes"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="costModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title text-dark"><i class="fas fa-money-bill-wave me-2"></i> Bổ sung Giá vốn (Cost)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info small py-2"><i class="fas fa-info-circle me-1"></i> Chỉ cần nhập giá trị ước lượng vào cột <b>Cost (Nhập)</b>.</div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light"><tr><th>Mã</th><th>Tên</th><th>SL</th><th>Giá bán</th><th>Cost (Nhập)</th><th>Ghi chú</th></tr></thead>
                                <tbody>
                                    <template x-for="(item, idx) in costItems" :key="item.TransactionID">
                                        <tr>
                                            <td x-text="item.InventoryID"></td>
                                            <td class="small" x-text="item.InventoryName"></td>
                                            <td x-text="item.QuoQuantity"></td>
                                            <td x-text="formatNum(item.UnitPrice)"></td>
                                            <td width="150"><input type="number" class="form-control form-control-sm" x-model="item.NewCost"></td>
                                            <td><input type="text" class="form-control form-control-sm" x-model="item.Note"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success text-white fw-bold" @click="saveCost()"><i class="fas fa-save me-2"></i> Lưu & Tính lại</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="salesmanModal" tabindex="-1">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Đổi NVKD</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="small mb-2">Báo giá: <strong x-text="detailNo"></strong></p>
                        <select class="form-select" x-model="newSalesman">
                            <option value="">-- Chọn NVKD --</option>
                            {% for s in salesman_list %}
                            <option value="{{ s.USERCODE }}">{{ s.SHORTNAME }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer p-2">
                        <button class="btn btn-primary w-100" @click="changeSalesman()">Lưu thay đổi</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
<script>
    function quoteApproval() {
        return {
            selectedId: null,
            detailNo: '',
            details: [],
            costItems: [],
            loading: false,
            justUpdated: null,
            newSalesman: '',
            modals: {},

            init() {
                this.modals.detail = new bootstrap.Modal(document.getElementById('detailModal'));
                this.modals.cost = new bootstrap.Modal(document.getElementById('costModal'));
                this.modals.salesman = new bootstrap.Modal(document.getElementById('salesmanModal'));
            },

            formatNum(val) {
                if(!val) return '0';
                return new Intl.NumberFormat('en-US').format(parseFloat(String(val).replace(/,/g, '')));
            },

            checkPrice(item) {
                let price = parseFloat(String(item.DonGia).replace(/,/g, ''));
                let std = parseFloat(String(item.DonGiaQuyDinh).replace(/,/g, ''));
                return price >= std;
            },

            loadDetails(id, no) {
                this.selectedId = id;
                this.detailNo = no;
                this.loading = true;
                this.modals.detail.show();
                
                fetch(`/api/get_quote_details/${id}`)
                    .then(r => r.json())
                    .then(data => {
                        this.details = data;
                        this.loading = false;
                    });
            },

            approve(id, no, clientId, empId, ratio) {
                if(!confirm(`Xác nhận duyệt Báo giá ${no}?`)) return;
                
                fetch('/api/approve_quote', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        quotation_id: id, quotation_no: no,
                        object_id: clientId, employee_id: empId, approval_ratio: ratio
                    })
                })
                .then(r => r.json())
                .then(res => {
                    if(res.success) {
                        Swal.fire('Thành công', res.message, 'success');
                        // Reload lại bảng bằng HTMX trigger hoặc reload trang
                        setTimeout(() => location.reload(), 1000); 
                    } else {
                        Swal.fire('Lỗi', res.message, 'error');
                    }
                });
            },

            openCostModal(id, no) {
                this.selectedId = id;
                this.detailNo = no;
                this.costItems = [];
                this.modals.cost.show();
                
                fetch(`/api/get_quote_cost_details/${id}`)
                    .then(r => r.json())
                    .then(data => {
                        this.costItems = data.map(i => ({...i, NewCost: i.Cost || '', Note: i.NOTE || ''}));
                    });
            },

            saveCost() {
                const updates = this.costItems
                    .filter(i => i.NewCost > 0)
                    .map(i => ({ transaction_id: i.TransactionID, cost: i.NewCost, note: i.Note }));
                
                if(updates.length === 0) return alert("Vui lòng nhập Cost.");

                fetch('/api/save_quote_cost_override', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ quote_id: this.selectedId, updates: updates })
                }).then(r => r.json()).then(res => {
                    if(res.success) {
                        this.modals.cost.hide();
                        Swal.fire('Thành công', 'Đã lưu Cost. Vui lòng đợi reload...', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else alert(res.message);
                });
            },

            openSalesmanModal(id, no, current) {
                this.selectedId = id;
                this.detailNo = no;
                this.newSalesman = current || '';
                this.modals.salesman.show();
            },

            changeSalesman() {
                if(!this.newSalesman) return alert("Chọn NVKD mới.");
                
                fetch('/api/quote/update_salesman', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ quotation_id: this.selectedId, new_salesman_id: this.newSalesman })
                }).then(r => r.json()).then(res => {
                    if(res.success) {
                        this.modals.salesman.hide();
                        this.justUpdated = this.selectedId;
                        Swal.fire('Updated', 'Đã đổi NVKD thành công.', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else alert(res.message);
                });
            }
        }
    }
</script>
{% endblock %}