{% extends "base.html" %}

{% block title %}Phân Tích Lợi Nhuận | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* KPI CARDS */
    .kpi-card { 
        border: none; border-radius: 16px; padding: 20px; color: white; 
        box-shadow: var(--shadow-sm); height: 100%; 
        position: relative; overflow: hidden;
    }
    .kpi-title { font-size: 0.85rem; font-weight: 600; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; }
    .kpi-value { font-size: 1.8rem; font-weight: 800; margin-top: 10px; }
    
    /* Gradients */
    .bg-revenue { background: linear-gradient(135deg, #4318FF 0%, #7B61FF 100%); }
    .bg-cogs { background: linear-gradient(135deg, #FFB547 0%, #FFCA85 100%); }
    .bg-profit { background: linear-gradient(135deg, #05CD99 0%, #0BE8B0 100%); }
    .bg-margin { background: linear-gradient(135deg, #E31A1A 0%, #FF5F5F 100%); }

    /* TABLE STYLES */
    .table { width: 100%; margin-bottom: 0; border-collapse: separate; border-spacing: 0; }
    
    .table thead th { 
        background-color: var(--input-bg); color: var(--secondary); 
        font-weight: 700; font-size: 0.8rem; text-transform: uppercase; 
        padding: 15px; border-bottom: 2px solid var(--border-color); cursor: pointer;
        white-space: nowrap; position: sticky; top: 0; z-index: 10;
    }
    .table thead th:hover { color: var(--primary); }
    
    .table td { 
        vertical-align: middle; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); 
        padding: 12px 15px; color: var(--text-dark);
    }

    /* Hierarchy Rows */
    .row-lvl-1 { background-color: var(--card-bg); font-weight: 700; cursor: pointer; }
    .row-lvl-1:hover { background-color: var(--input-bg); }
    
    .row-lvl-2 { background-color: var(--input-bg); cursor: pointer; }
    .row-lvl-2 td { border-bottom: 1px dashed var(--border-color); color: var(--text-dark); opacity: 0.9; }
    .row-lvl-2:hover { background-color: rgba(0,0,0,0.05); }

    .row-lvl-3 { background-color: var(--bg-color); }
    .row-lvl-3 td { font-size: 0.85rem; color: var(--secondary); border-bottom: 1px solid var(--border-color); }
    
    /* Icons & Text Colors */
    .icon-expand { transition: transform 0.2s; display: inline-block; }
    .expanded .icon-expand { transform: rotate(90deg); }
    
    .text-loss { color: var(--danger) !important; }
    .text-success-custom { color: var(--success) !important; }
    
    .filter-box { 
        background: var(--card-bg); padding: 8px 15px; 
        border-radius: 12px; border: 1px solid var(--border-color);
        display: flex; align-items: center; gap: 10px;
    }
    .sort-icon { margin-left: 5px; font-size: 0.7rem; color: var(--secondary); }
    .sort-active { color: var(--primary); }

    /* Helper Classes for Alpine */
    [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block page_title %}Phân Tích Lợi Nhuận{% endblock %}
{% block page_sub %}Hiệu quả kinh doanh theo Khách hàng & Đơn hàng{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2 filter-container" x-data>
    <div class="filter-box">
        <i class="fas fa-search text-muted"></i>
        <input type="text" 
               @input="$dispatch('search-table', $el.value)"
               class="form-control form-control-sm border-0 shadow-none p-0 bg-transparent" 
               placeholder="Tìm nhanh...">
    </div>

    <form class="filter-box" 
          hx-post="{{ url_for('kpi_bp.profit_analysis_dashboard') }}" 
          hx-target="body" 
          hx-swap="outerHTML">
          
        <input type="date" name="date_from" class="form-control form-control-sm border-0 bg-transparent p-0" value="{{ date_from }}" style="width: 110px;">
        <i class="fas fa-arrow-right text-muted small"></i>
        <input type="date" name="date_to" class="form-control form-control-sm border-0 bg-transparent p-0" value="{{ date_to }}" style="width: 110px;">
        <button type="submit" class="btn btn-primary btn-sm rounded-circle shadow-sm" style="width: 30px; height: 30px; padding: 0;">
            <i class="fas fa-filter"></i>
        </button>
    </form>
</div>
{% endblock %}

{% block content %}
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-revenue">
                <div class="kpi-title">DOANH THU</div>
                <div class="kpi-value">{{ summary.Revenue | format_tr }}</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-cogs">
                <div class="kpi-title">GIÁ VỐN</div>
                <div class="kpi-value">{{ summary.COGS | format_tr }}</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-profit">
                <div class="kpi-title">LÃI GỘP</div>
                <div class="kpi-value">{{ summary.GrossProfit | format_tr }}</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-margin">
                <div class="kpi-title">% MARGIN</div>
                <div class="kpi-value">{{ "{:.1f}%".format(summary.AvgMargin) }}</div>
            </div>
        </div>
    </div>

    <div class="main-card" x-data="profitTable()">
        <div class="table-responsive">
            <table class="table" id="mainTable">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th @click="sort('name')">ĐỐI TƯỢNG <i class="fas fa-sort sort-icon" :class="getSortClass('name')"></i></th>
                        <th @click="sort('sales')">NV <i class="fas fa-sort sort-icon" :class="getSortClass('sales')"></i></th>
                        <th class="text-end" @click="sort('revenue')">DOANH THU <i class="fas fa-sort sort-icon" :class="getSortClass('revenue')"></i></th>
                        <th class="text-end">GIÁ VỐN</th>
                        <th class="text-end" @click="sort('profit')">LÃI GỘP <i class="fas fa-sort sort-icon" :class="getSortClass('profit')"></i></th>
                        <th class="text-center" @click="sort('margin')">% <i class="fas fa-sort sort-icon" :class="getSortClass('margin')"></i></th>
                        <th class="text-center" style="width: 80px;">#</th>
                    </tr>
                </thead>
                
                {% for cust in details %}
                <tbody class="customer-group" 
                       x-data="{ expanded: false }"
                       x-show="matchesSearch('{{ cust.Name }} {{ cust.ID }} {{ cust.SalesMan }}')"
                       data-name="{{ cust.Name }}" 
                       data-sales="{{ cust.SalesMan }}"
                       data-revenue="{{ cust.Revenue }}"
                       data-profit="{{ cust.Profit }}"
                       data-margin="{{ cust.Margin }}">
                    
                    <tr class="row-lvl-1" @click="expanded = !expanded" :class="{'expanded': expanded}">
                        <td class="text-center">
                            <i class="fas fa-chevron-right icon-expand text-primary" :style="expanded ? 'transform: rotate(90deg)' : ''"></i>
                        </td>
                        <td>
                            <div class="text-truncate fw-bold" style="max-width: 300px;" title="{{ cust.Name }}">{{ cust.Name }}</div>
                            <div class="small text-muted">{{ cust.ID }}</div>
                        </td>
                        <td class="text-muted small">{{ cust.SalesMan }}</td>
                        <td class="text-end fw-bold">{{ cust.Revenue | format_tr }}</td>
                        <td class="text-end text-muted">{{ cust.COGS | format_tr }}</td>
                        <td class="text-end fw-bold {{ 'text-loss' if cust.Profit < 0 else 'text-success-custom' }}">{{ cust.Profit | format_tr }}</td>
                        <td class="text-center fw-bold {{ 'text-loss' if cust.Margin < 10 else '' }}">{{ "{:.1f}%".format(cust.Margin) }}</td>
                        <td class="text-center" @click.stop>
                            <a href="/customer_360/{{ cust.ID }}" target="_blank" 
                               class="btn btn-sm btn-light border shadow-sm text-primary"
                               title="360° View">
                                <i class="fas fa-chart-pie"></i>
                            </a>
                        </td>
                    </tr>

                    {% for order in cust.Orders %}
                    
                    <tr class="row-lvl-2" 
                        x-show="expanded" 
                        x-cloak 
                        x-transition
                        @click="toggleOrder('{{ order.SoDonHang }}')" 
                        :class="{'expanded': isOrderOpen('{{ order.SoDonHang }}')}">
                        
                        <td class="text-center">
                            <i class="fas fa-caret-right icon-expand text-secondary" 
                               :style="isOrderOpen('{{ order.SoDonHang }}') ? 'transform: rotate(90deg)' : ''">
                            </i>
                        </td>
                        <td class="ps-4">
                            <span class="fw-bold">{{ order.SoDonHang }}</span>
                            <span class="badge bg-white text-dark border ms-2">{{ order.VoucherNo }}</span>
                        </td>
                        <td class="small text-muted">{{ order.Date | format_date }}</td>
                        <td class="text-end">{{ order.Revenue | format_tr }}</td>
                        <td class="text-end small">{{ order.COGS | format_tr }}</td>
                        <td class="text-end {{ 'text-loss' if order.Profit < 0 else '' }}">{{ order.Profit | format_tr }}</td>
                        <td class="text-center small {{ 'text-loss' if order.Margin < 10 else 'text-muted' }}">{{ "{:.1f}%".format(order.Margin) }}</td>
                        <td></td>
                    </tr>

                    {% for item in order.Items %}
                    <tr class="row-lvl-3" 
                        x-show="expanded && isOrderOpen('{{ order.SoDonHang }}')" 
                        x-cloak 
                        x-transition>
                        <td></td>
                        <td class="ps-5">
                            <div class="small fw-bold">{{ item.MaHang }}</div>
                            <div class="text-muted text-truncate small" style="max-width: 250px;">{{ item.TenHang }}</div>
                        </td>
                        <td class="small text-muted">SL: {{ item.SoLuong | format_number }}</td>
                        <td class="text-end small">{{ item.DoanhThu | format_tr }}</td>
                        <td class="text-end small text-muted">{{ item.GiaVon | format_tr }}</td>
                        <td class="text-end small {{ 'text-loss' if item.LaiGop < 0 else 'text-success-custom' }}">{{ item.LaiGop | format_tr }}</td>
                        <td class="text-center small {{ 'text-loss' if item.TyLeLaiGop < 10 else 'text-muted' }}">{{ "{:.1f}%".format(item.TyLeLaiGop) }}</td>
                        <td></td>
                    </tr>
                    {% endfor %}
                    
                    {% endfor %} 
                </tbody>
                {% endfor %}
                
                {% if not details %}
                <tbody><tr><td colspan="8" class="text-center py-5 text-muted">Không có dữ liệu phù hợp.</td></tr></tbody>
                {% endif %}
            </table>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function profitTable() {
        return {
            sortCol: 'profit',
            sortAsc: false,
            search: '',
            openOrders: [], 

            init() {
                // Lắng nghe sự kiện search từ input bên ngoài
                window.addEventListener('search-table', (e) => {
                    this.search = e.detail.toLowerCase();
                });
            },

            matchesSearch(text) {
                if (!this.search) return true;
                return text.toLowerCase().includes(this.search);
            },

            // Logic Sort
            sort(col) {
                if (this.sortCol === col) this.sortAsc = !this.sortAsc;
                else { this.sortCol = col; this.sortAsc = false; }

                const table = document.getElementById('mainTable');
                const tbodies = Array.from(document.querySelectorAll('tbody.customer-group'));

                tbodies.sort((a, b) => {
                    let valA = a.dataset[col];
                    let valB = b.dataset[col];

                    if (col !== 'name' && col !== 'sales') {
                        valA = parseFloat(valA) || 0;
                        valB = parseFloat(valB) || 0;
                    }

                    if (valA < valB) return this.sortAsc ? -1 : 1;
                    if (valA > valB) return this.sortAsc ? 1 : -1;
                    return 0;
                });

                tbodies.forEach(tbody => table.appendChild(tbody));
            },

            getSortClass(col) {
                if (this.sortCol !== col) return 'text-muted';
                return this.sortAsc ? 'fa-sort-up sort-active' : 'fa-sort-down sort-active';
            },

            toggleOrder(orderId) {
                if (this.openOrders.includes(orderId)) {
                    this.openOrders = this.openOrders.filter(id => id !== orderId);
                } else {
                    this.openOrders.push(orderId);
                }
            },
            
            isOrderOpen(orderId) {
                return this.openOrders.includes(orderId);
            }
        }
    }
</script>
{% endblock %}