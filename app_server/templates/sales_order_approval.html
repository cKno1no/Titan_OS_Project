{% extends "base.html" %}

{% block title %}Duyệt Đơn Hàng Bán (DHB) | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* TABLE LAYOUT (Đồng bộ với Quote Approval) */
    .table-container { 
        max-height: 80vh; overflow-y: auto; 
        border: 1px solid var(--border-color); border-radius: 12px;
    }
    
    .table-approval th { 
        position: sticky; top: 0; z-index: 10;
        background-color: var(--input-bg) !important; 
        color: var(--secondary) !important;
        font-weight: 700; font-size: 0.85rem; text-transform: uppercase;
        padding: 15px 10px; border-bottom: 2px solid var(--border-color);
        white-space: nowrap; text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .table-approval td { 
        vertical-align: middle; font-size: 0.9rem; 
        border-bottom: 1px solid var(--border-color);
        padding: 12px 10px; color: var(--text-dark);
    }

    /* Status & Logic */
    .quote-row { transition: background-color 0.2s; cursor: pointer; }
    .quote-row:hover td { background-color: var(--input-bg) !important; }
    .quote-row.selected td { background-color: rgba(67, 24, 255, 0.05) !important; color: var(--primary); font-weight: 600; }
    
    .status-border { border-left: 5px solid transparent; }
    .status-pass { border-left-color: var(--success); }
    .status-fail { border-left-color: var(--danger); }
    .status-pending { border-left-color: var(--warning); }
    
    .ratio-alert { color: var(--danger); font-weight: 800; }
    .bg-highlight { animation: highlightFade 2s forwards; }
    @keyframes highlightFade { 0% { background-color: rgba(5, 205, 153, 0.2); } 100% { background-color: transparent; } }

    /* Columns Specific */
    .col-ratio { width: 80px; text-align: right; }
    .col-nvkd { width: 150px; text-align: center; }
    .col-gt { width: 140px; text-align: right; font-weight: 700; }
    .col-result { max-width: 350px; }

    /* Modal Details */
    .table-detail th { background: var(--primary) !important; color: white !important; font-size: 0.8rem; text-align: center; }
    .table-detail td { font-size: 0.9rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    
    /* Loading Overlay */
    .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
    .htmx-request .htmx-indicator { opacity: 1; }
    .htmx-request.htmx-indicator { opacity: 1; }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-shipping-fast me-2 text-success"></i> PHÊ DUYỆT ĐƠN HÀNG BÁN{% endblock %}
{% block page_sub %}Các đơn hàng chờ duyệt để chuyển sang ERP{% endblock %}

{% block header_actions %}
<a href="/" class="btn btn-back"><i class="fas fa-home me-2"></i>Portal</a>
<a href="{{ url_for('approval_bp.quote_approval_dashboard') }}" class="btn btn-primary text-white shadow-sm fw-bold">
    <i class="fas fa-file-signature me-2"></i>Duyệt Chào Giá
</a>
{% endblock %}

{% block content %}
    <div class="main-card mb-4" x-data>
        <div class="card-body-custom" style="padding: 20px;">
            <form hx-post="{{ url_for('approval_bp.sales_order_approval_dashboard') }}" 
                  hx-target="#table-container" 
                  hx-select="#table-container"
                  hx-swap="outerHTML"
                  class="row g-3 align-items-end">
                  
                <div class="col-md-3">
                    <label class="form-label text-secondary small fw-bold">Từ Ngày</label>
                    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-secondary small fw-bold">Đến Ngày</label>
                    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100 fw-bold">
                        <i class="fas fa-filter me-2"></i> Lọc
                        <span class="htmx-indicator spinner-border spinner-border-sm ms-2"></span>
                    </button>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text border-0 bg-transparent ps-3" style="position: absolute; z-index: 10;"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" name="search" class="form-control ps-5" placeholder="Tìm Mã DHB, Khách hàng..."
                               hx-post="{{ url_for('approval_bp.sales_order_approval_dashboard') }}"
                               hx-trigger="keyup changed delay:500ms"
                               hx-target="#table-container"
                               hx-select="#table-container"
                               hx-swap="outerHTML"
                               hx-include="[name='date_from'], [name='date_to']">
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="main-card" x-data="orderApproval()">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <span><i class="fas fa-list-ul me-2 text-success"></i> DANH SÁCH ĐƠN HÀNG ({{ orders|length }})</span>
        </div>
        
        <div id="table-container" class="card-body-custom p-0">
            <div class="table-container">
                <table class="table table-hover table-approval mb-0">
                    <thead>
                        <tr>
                            <th class="col-ratio">Hệ số</th>           
                            <th>Mã DHB</th>
                            <th>Loại</th>
                            <th>Ngày</th>                           
                            <th class="text-start">Khách hàng</th>
                            <th class="col-nvkd">NVKD</th>            
                            <th class="col-gt">Tổng GT</th>     
                            <th class="col-result text-start">KẾT QUẢ KIỂM TRA</th>
                            <th class="text-center" style="width: 100px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        {% set result = order.ApprovalResult %}
                        {% set status = result.Passed %}
                        {% set approver_id = result.ApproverRequired %}
                        {% set row_class = 'status-pass' if status else ('status-pending' if 'PENDING' in result.Reason else 'status-fail') %}
                        
                        <tr class="quote-row status-border {{ row_class }}" 
                            :class="{'selected': selectedSOrderId === '{{ order.SOrderID }}'}"
                            @click="loadDetails('{{ order.SOrderID }}', '{{ order.OrderID }}')">
                            
                            <td class="text-end col-ratio">
                                <span class="fw-bold {% if result.ApprovalRatio < 138 %} ratio-alert {% endif %}">
                                    {{ result.ApprovalRatio }}
                                </span>
                            </td>
                            
                            <td class="fw-bold text-primary">{{ order.OrderID }}</td>
                            <td class="text-center small">{{ order.VoucherTypeID }}</td>
                            <td class="text-center small">{{ order.OrderDate | format_date }}</td>
                            
                            <td class="text-start text-truncate" style="max-width: 250px;" title="{{ order.ClientName }}">
                                {{ order.ClientName | default('N/A') }}
                            </td>
                            
                            <td class="col-nvkd text-center small">
                                {{ order.NVKDName | default(order.SalesManID) }}
                            </td>
                            
                            <td class="text-end col-gt text-dark">{{ order.SaleAmount | format_tr }}</td>
                            
                            <td class="col-result text-start small">
                                {% if result.Passed %}
                                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>{{ result.Reason }}</span>
                                {% else %}
                                    <span class="{{ 'text-warning' if 'PENDING' in result.Reason else 'text-danger' }}">
                                        {{ result.Reason }}
                                    </span>
                                {% endif %}
                            </td>
                            
                            <td class="text-center">
                                {% if status and current_user_code in approver_id %}
                                    <button class="btn btn-success btn-sm shadow-sm text-white px-3 fw-bold" 
                                            @click.stop="approve('{{ order.OrderID }}', '{{ order.SOrderID }}', '{{ order.ClientID }}', '{{ order.SalesManID }}', {{ result.ApprovalRatio }})">
                                        <i class="fas fa-check me-1"></i> Duyệt
                                    </button>
                                {% elif current_user_code in approver_id and 'FAILED' in result.Reason %}
                                    <span class="badge bg-danger">Lỗi</span>
                                {% elif result.ApproverDisplay == 'TỰ DUYỆT (SELF - DTK < 100M)' %}
                                    <span class="badge bg-success"><i class="fas fa-check-double me-1"></i> Tự duyệt</span>
                                {% else %}
                                    <span class="badge bg-light text-secondary border">Chờ xử lý</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="9" class="text-center text-muted py-5">Không có đơn hàng nào.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-info-circle me-2 text-primary"></i> Chi tiết: <span x-text="orderId" class="fw-bold"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div x-show="loading" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Đang tải dữ liệu...</div>
                        
                        <div class="table-responsive" x-show="!loading">
                            <table class="table table-sm table-striped table-bordered mb-0 table-detail">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th class="text-center">Mã hàng</th>
                                        <th>Tên hàng</th>
                                        <th class="text-end">SL</th>
                                        <th class="text-end">Đơn giá</th>
                                        <th class="text-end">Giá QĐ</th>
                                        <th class="text-end">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in details" :key="index">
                                        <tr>
                                            <td class="text-center text-muted small" x-text="index + 1"></td>
                                            <td class="text-center font-monospace" x-text="item.MaHang"></td>
                                            <td x-text="item.TenHang"></td>
                                            <td class="text-end" x-text="formatNum(item.SoLuong)"></td>
                                            <td class="text-end" x-text="formatNum(item.DonGia)"></td>
                                            <td class="text-end" :class="checkPrice(item) ? 'text-success' : 'text-danger fw-bold'" x-text="formatNum(item.DonGiaQuyDinh)"></td>
                                            <td class="text-end fw-bold" x-text="formatNum(item.ThanhTien)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function orderApproval() {
        return {
            selectedSOrderId: null,
            orderId: '',
            details: [],
            loading: false,
            detailModal: null,

            init() {
                this.detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            },

            formatNum(val) {
                if (!val) return '0';
                return new Intl.NumberFormat('en-US').format(parseFloat(String(val).replace(/,/g, '')));
            },
            
            checkPrice(item) {
                let p = parseFloat(String(item.DonGia).replace(/,/g, ''));
                let qd = parseFloat(String(item.DonGiaQuyDinh).replace(/,/g, ''));
                return p >= qd;
            },

            loadDetails(sId, oId) {
                this.selectedSOrderId = sId;
                this.orderId = oId;
                this.loading = true;
                this.detailModal.show();
                
                // [NOTE] Dùng encodeURIComponent cho sId để an toàn
                fetch(`/api/get_order_details/${encodeURIComponent(sId)}`)
                    .then(r => r.json())
                    .then(data => {
                        this.details = data;
                        this.loading = false;
                    })
                    .catch(e => {
                        this.loading = false;
                        alert("Lỗi tải chi tiết: " + e);
                    });
            },

            approve(oId, sId, clientId, smId, ratio) {
                if (!confirm(`Xác nhận duyệt Đơn hàng ${oId}? Dữ liệu sẽ chuyển sang ERP.`)) return;
                
                fetch('/api/approve_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        order_id: oId, sorder_id: sId, client_id: clientId, salesman_id: smId, approval_ratio: ratio 
                    }),
                })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        Swal.fire('Thành công', res.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        Swal.fire('Lỗi duyệt', res.message, 'error');
                    }
                })
                .catch(e => Swal.fire('Lỗi kết nối', e.message, 'error'));
            }
        }
    }
</script>
{% endblock %}