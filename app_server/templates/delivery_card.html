{% set status_class = 'status-' + item.DeliveryStatus|lower %}

{# Lấy chuỗi ngày Y/C Giao (Dùng cho logic Quá hạn) #}
{% set item_iso_date = (item.EarliestRequestDate.split(' ')[0] if item.EarliestRequestDate else '9999-12-31') %}
{% set is_overdue = (item_iso_date < current_date_str) and (item.DeliveryStatus == 'Open') %}

{% if is_overdue %}
    {% set status_class = status_class + ' overdue' %}
{% endif %}

<div class="delivery-card {{ status_class }} {% if not can_edit_dispatch %}no-edit{% endif %}" 
     id="lxh-{{ item.VoucherID }}"
     data-voucher-id="{{ item.VoucherID }}"
     data-planned-date="{{ item.Planned_Date_ISO | default('9999-12-31') }}"
     data-actual-delivery-date="{{ item.ActualDeliveryDate_ISO | default('1900-01-01') }}"
     onclick="openConfirmationModal(this)">
    
    <div class="item-title">{{ item.VoucherNo }} ({{ item.ItemCount }} MH)</div>
    <div class="item-customer">{{ item.ObjectName }}</div>
    <div class="item-details">
        {% if item.DeliveryStatus == 'Da Giao' %}
            <strong class="text-success" style="font-size: 0.85rem;"><i class="fas fa-check-circle me-1"></i> Đã Giao: {{ item.ActualDeliveryDate_str }}</strong><br>
        {% elif item.Planned_Day_Display %}
            <strong class="text-primary" style="font-size: 0.85rem;"><i class="fas fa-calendar-check me-1"></i> Giao: {{ item.Planned_Day_Display }}</strong><br>
        {% endif %}
        
        Ngày LXH: {{ item.VoucherDate | format_date }} <br>
        RefNo02: {{ item.RefNo02 or '—' }}
        
        {% if is_overdue %}
            <br><strong class="text-danger">QUÁ HẠN (Y/C: {{ item.EarliestRequestDate_str }})</strong>
        {% endif %}
    </div>
</div>