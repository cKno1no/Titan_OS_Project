{% extends "base.html" %}

{% block title %}Chi tiết Danh mục Đào tạo - Titan OS{% endblock %}

{% block extra_css %}
<style>
    :root {
        --bg-light: #f4f7f9; 
        --card-bg: #ffffff;
        --text-primary: #1e293b; 
        --text-secondary: #64748b; 
        --accent-color: #2563eb; 
        --border-color: #e2e8f0; 
    }
    
    body { background-color: var(--bg-light) !important; color: var(--text-primary) !important; font-family: 'Inter', sans-serif; }
    
    .category-hero {
        padding: 50px 5% 30px;
        background: linear-gradient(to right, rgba(37, 99, 235, 0.05), #ffffff);
        border-bottom: 1px solid var(--border-color); margin-bottom: 30px;
    }
    
    /* FILTER PILLS - Gia cố để hiển thị tốt khi có nhiều Sub-category */
    .filter-pill {
        background: #ffffff; border: 1px solid var(--border-color); color: var(--text-secondary);
        padding: 8px 20px; border-radius: 30px; cursor: pointer; transition: all 0.2s ease;
        white-space: nowrap; font-size: 0.95rem; font-weight: 500;
        display: flex; align-items: center; gap: 8px;
    }
    .filter-pill:hover { background: #f1f5f9; color: var(--text-primary); }
    .filter-pill.active { background: var(--accent-color); color: white; border-color: var(--accent-color); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
    
    /* COURSE CARD - Hiệu ứng chuyên gia */
    .course-card {
        background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 16px;
        overflow: hidden; transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column;
        cursor: pointer; position: relative;
    }
    .course-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); border-color: #cbd5e1; }
    
    .thumb-wrapper { position: relative; width: 100%; height: 140px; overflow: hidden; background: #f8fafc; border-bottom: 1px solid var(--border-color); }
    .course-thumb { width: 100%; height: 100%; object-fit: contain; padding: 15px; transition: transform 0.5s ease; }
    .course-card:hover .course-thumb { transform: scale(1.05); }

    .course-overlay {
        position: absolute; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px);
        color: white; display: flex; flex-direction: column; justify-content: center; align-items: center;
        padding: 20px; text-align: center; opacity: 0; transition: all 0.3s ease;
        transform: translateY(10px);
    }
    .course-card:hover .course-overlay { opacity: 1; transform: translateY(0); }
    
    .overlay-desc { font-size: 0.85rem; line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; color: #e2e8f0; }
    .overlay-btn { background: var(--accent-color); color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; transition: background 0.2s; }
    .overlay-btn:hover { background: #1d4ed8; }

    .course-body { padding: 15px 20px 20px; flex-grow: 1; display: flex; flex-direction: column; }
    .course-title { font-size: 1.05rem; font-weight: 700; color: var(--text-primary); margin-bottom: auto; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
    
    .course-meta-divider { height: 1px; background: var(--border-color); margin: 15px 0; }
    .course-meta { font-size: 0.85rem; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
    .meta-item { display: flex; align-items: center; gap: 6px; }
</style>
{% endblock %}

{% block content %}
<div x-data="categoryApp()" x-cloak>
    
    <div class="category-hero">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="/training" class="text-secondary text-decoration-none"><i class="fas fa-home"></i> Thư viện</a></li>
                <li class="breadcrumb-item active text-primary fw-bold" aria-current="page" x-text="catName"></li>
            </ol>
        </nav>
        <h1 class="fw-bold mb-2 text-dark" x-text="catName"></h1>
        <p class="text-secondary mb-0">
            <i class="fas fa-book-open text-primary me-1"></i> Có <span x-text="totalCourses" class="fw-bold text-dark"></span> khóa học (đã tối ưu < 10 bài/khóa)
        </p>
    </div>

    <div class="container-fluid px-md-5 pb-5">
        <div x-show="isLoading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-secondary">Đang tải lộ trình đào tạo...</p>
        </div>

        <div x-show="!isLoading">
            <div class="d-flex flex-wrap gap-2 mb-4" x-show="subCategories.length > 0">
                <button class="filter-pill" :class="{'active': activeSubCat === 'all'}" @click="activeSubCat = 'all'">
                    Tất cả <span class="badge bg-light text-dark ms-1 rounded-pill border" x-text="totalCourses"></span>
                </button>
                <template x-for="sub in subCategories" :key="sub.name">
                    <button class="filter-pill" :class="{'active': activeSubCat === sub.name}" @click="activeSubCat = sub.name">
                        <span x-text="sub.name"></span>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary ms-1 rounded-pill" x-text="sub.courses.length"></span>
                    </button>
                </template>
            </div>

            <div x-show="subCategories.length === 0" class="text-center py-5">
                <div class="mb-3"><i class="fas fa-box-open" style="font-size: 4rem; color: #cbd5e1"></i></div>
                <h5 class="text-dark fw-bold">Chưa có dữ liệu cho danh mục này</h5>
                <p class="text-secondary">Vui lòng quay lại sau hoặc liên hệ Admin để cập nhật bài học.</p>
                <a href="/training" class="btn btn-outline-primary mt-3"><i class="fas fa-arrow-left me-1"></i> Quay lại Thư viện</a>
            </div>

            <div class="row g-4">
                <template x-for="sub in subCategories" :key="sub.name">
                    <template x-if="activeSubCat === 'all' || activeSubCat === sub.name">
                        <template x-for="course in sub.courses" :key="course.id">
                            <div class="col-12 col-md-6 col-lg-4 col-xl-3 animate__animated animate__fadeIn">
                                <div class="course-card" @click="window.open('/training/course/' + course.id, '_blank')">
                                    <div class="thumb-wrapper">
                                        <img :src="course.thumbnail || '/static/img/3d_assets/culture/books.png'" class="course-thumb" alt="Thumbnail">
                                        <div style="position: absolute; top: 10px; left: 10px; background: rgba(15, 23, 42, 0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">
                                            ID: <span x-text="course.id"></span>
                                        </div>
                                        <div class="course-overlay">
                                            <p class="overlay-desc" x-text="course.desc || 'Khóa học chuyên sâu giúp nâng cao năng lực thực tế.'"></p>
                                            <button class="overlay-btn">Vào Học Ngay</button>
                                        </div>
                                    </div>
                                    <div class="course-body">
                                        <h5 class="course-title" x-text="course.title"></h5>
                                        <div class="course-meta-divider"></div>
                                        <div class="course-meta">
                                            <div class="meta-item text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">
                                                <i class="fas fa-file-alt"></i> <span x-text="(course.lessons || 0) + ' Bài học'"></span>
                                            </div>
                                            <div class="meta-item text-dark fw-bold">
                                                <i class="fas fa-star text-warning"></i> <span x-text="course.xp || 300"></span> XP
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </template>
                </template>
            </div>
        </div>
    </div>
</div>

<script>
    function categoryApp() {
        return {
            catName: '',
            subCategories: [],
            activeSubCat: 'all',
            totalCourses: 0,
            isLoading: true,

            async init() {
                // 1. Lấy tên Category từ URL và làm sạch
                let path = window.location.pathname.replace(/\/$/, '');
                this.catName = decodeURIComponent(path.split('/').pop());
                
                try {
                    // 2. Gọi API Dashboard chung để lấy cấu trúc cây dữ liệu
                    const res = await fetch('/api/training/dashboard_v2');
                    const data = await res.json();
                    
                    const searchCat = this.catName.toLowerCase().replace(/\s+/g, ' ').trim();
                    
                    // 3. TÁCH RỜI LOGIC SO KHỚP CHỐNG LỖI "NHẬN NHẦM"
                    // Bước 3.1: Ưu tiên tìm khớp CHÍNH XÁC 100% trước
                    let currentCatKey = Object.keys(data).find(k => {
                        const apiCat = k.toLowerCase().replace(/\s+/g, ' ').trim();
                        return apiCat === searchCat;
                    });
                    
                    // Bước 3.2: Nếu không khớp chính xác, MỚI chạy tìm kiếm có chứa từ khóa
                    if (!currentCatKey) {
                        currentCatKey = Object.keys(data).find(k => {
                            const apiCat = k.toLowerCase().replace(/\s+/g, ' ').trim();
                            return apiCat.includes(searchCat) || searchCat.includes(apiCat);
                        });
                    }
                    
                    if (currentCatKey && data[currentCatKey]) {
                        // Cập nhật lại tên Category chuẩn xác từ DB (ví dụ: Quy trình & Vận hành thay vì chuỗi từ URL)
                        this.catName = currentCatKey; 

                        const rawSubCats = data[currentCatKey];
                        let processedSubs = {};
                        
                        // 4. Tổ chức lại SubCategory
                        for (let subName of Object.keys(rawSubCats)) {
                            // Gom nhóm 'null' hoặc rỗng vào Chuyên đề chung
                            let cleanSubName = (!subName || subName === 'null' || String(subName).trim() === '') 
                                               ? 'Chuyên đề chung' 
                                               : String(subName).trim();
                            
                            if (!processedSubs[cleanSubName]) processedSubs[cleanSubName] = [];
                            
                            // Map dữ liệu từ API về định dạng hiển thị, hỗ trợ bóc tách CourseID/Title mới
                            const courses = rawSubCats[subName].map(c => ({
                                id: c.id || c.CourseID,
                                title: c.title || c.Title || 'Khóa học không tên',
                                desc: c.desc || c.Description || '',
                                thumbnail: c.thumbnail || c.ThumbnailUrl,
                                lessons: c.lessons || c.TotalLessons || 0,
                                xp: c.xp || c.XP_Reward || 300
                            }));
                            
                            processedSubs[cleanSubName].push(...courses);
                        }
                        
                        // 5. Chuyển đổi object thành mảng để render
                        this.subCategories = Object.keys(processedSubs).map(name => ({
                            name: name,
                            courses: processedSubs[name]
                        }));
                        
                        // Sắp xếp: Sub-category nhiều khóa học hơn hiện lên trước
                        this.subCategories.sort((a, b) => b.courses.length - a.courses.length);
                        this.totalCourses = this.subCategories.reduce((acc, sub) => acc + sub.courses.length, 0);
                    } else {
                        console.warn("⚠️ Không tìm thấy khớp dữ liệu cho Category:", searchCat);
                    }
                } catch(e) {
                    console.error("❌ Lỗi fetch dữ liệu Detail:", e);
                } finally {
                    this.isLoading = false;
                }
            }
        }
    }
</script>
{% endblock %}